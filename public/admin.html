<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>後台管理 - Lead Magnet Platform</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f9fafb;
        color: #111827;
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Layout */
      .admin-layout {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 256px;
        background-color: #1f2937;
        color: white;
        padding: 1.5rem 0;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 0 1.5rem 2rem;
        border-bottom: 1px solid #374151;
      }

      .sidebar-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #f9fafb;
      }

      .sidebar-nav {
        margin-top: 2rem;
      }

      .nav-section {
        margin-bottom: 2rem;
      }

      .nav-section-title {
        padding: 0 1.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
      }

      .nav-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        color: #d1d5db;
        text-decoration: none;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }

      .nav-item:hover,
      .nav-item.active {
        background-color: #374151;
        color: #f9fafb;
        border-left-color: #f97316;
      }

      .nav-icon {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.75rem;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* Header */
      .header {
        background-color: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 2rem;
        display: flex;
        justify-content: between;
        align-items: center;
      }

      .header-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #111827;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: #f3f4f6;
        border-radius: 2rem;
        border: 1px solid #e5e7eb;
      }

      .user-avatar {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
      }

      /* Content Area */
      .content {
        padding: 2rem;
        flex: 1;
      }

      /* Cards */
      .card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
      }

      .card-content {
        padding: 1.5rem;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
      }

      .btn-primary {
        background-color: #f97316;
        color: white;
        font-weight: 600;
        transition: all 0.2s;
        transform: scale(1);
      }

      .btn-primary:hover {
        background-color: #ea580c;
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      }

      .btn-secondary {
        background-color: #6b7280;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #4b5563;
      }

      .btn-success {
        background-color: #059669;
        color: white;
      }

      .btn-danger {
        background-color: #dc2626;
        color: white;
      }

      /* File Upload Area */
      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #3b82f6;
        background-color: #f8fafc;
      }

      .upload-area.dragover {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }

      /* Table */
      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th,
      .table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      .table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
      }

      .table tbody tr:hover {
        background-color: #f9fafb;
      }

      /* Form */
      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
      }

      .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
      }

      .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .form-textarea {
        min-height: 4rem;
        resize: vertical;
      }

      /* Status badges */
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .badge-success {
        background-color: #dcfce7;
        color: #059669;
      }

      .badge-warning {
        background-color: #fef3c7;
        color: #d97706;
      }

      .badge-danger {
        background-color: #fee2e2;
        color: #dc2626;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .modal-title {
        font-size: 1.125rem;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
      }

      /* Tabs */
      .tabs {
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
      }

      .tab-list {
        display: flex;
        gap: 0;
      }

      .tab {
        padding: 0.75rem 1rem;
        border: none;
        background: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        color: #6b7280;
        font-weight: 500;
      }

      .tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Loading */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .spinner {
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        width: 2rem;
        height: 2rem;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Utilities */
      .hidden {
        display: none;
      }
      .text-center {
        text-align: center;
      }
      .text-right {
        text-align: right;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .gap-2 {
        gap: 0.5rem;
      }
      
      /* Image Manager Styles */
      .image-manager {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        background: #f9fafb;
        margin-bottom: 1rem;
      }
      
      .image-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .image-item {
        position: relative;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        overflow: hidden;
        background: white;
      }
      
      .image-item img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        display: block;
      }
      
      .image-item-controls {
        position: absolute;
        top: 4px;
        right: 4px;
        display: flex;
        gap: 4px;
      }
      
      .image-btn {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
      }
      
      .image-btn:hover {
        background: rgba(0, 0, 0, 0.9);
      }
      
      .image-add-options {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
      }
      
      .image-upload-area, .image-url-area {
        padding: 1rem;
        border: 1px dashed #d1d5db;
        border-radius: 8px;
        background: white;
      }
      
      .upload-preview {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.5rem;
      }
      
      .upload-preview img {
        width: 100%;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }
      
      .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
      }
      
      .carousel-container {
        position: relative;
        margin-bottom: 1.5rem;
      }
      
      .carousel-slides {
        display: flex;
        overflow: hidden;
        border-radius: 12px;
      }
      
      .carousel-slide {
        min-width: 100%;
        transition: transform 0.3s ease;
      }
      
      .carousel-slide img {
        width: 100%;
        height: 300px;
        object-fit: cover;
      }
      
      .carousel-controls {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
      }
      
      .carousel-prev {
        left: 10px;
      }
      
      .carousel-next {
        right: 10px;
      }
      
      .carousel-indicators {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 12px;
      }
      
      .carousel-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #d1d5db;
        cursor: pointer;
        transition: background 0.3s;
      }
      
      .carousel-indicator.active {
        background: #16a34a;
      }

      /* 檔案管理視圖樣式 */
      .files-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 0 5px;
      }

      .view-toggle {
        display: flex;
        background: #f1f3f4;
        border-radius: 8px;
        padding: 4px;
        gap: 4px;
      }

      .view-toggle button {
        background: transparent;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        font-size: 14px;
      }

      .view-toggle button.active {
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      .view-toggle button:hover:not(.active) {
        background: rgba(255,255,255,0.7);
      }

      /* 網格視圖 */
      .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        padding: 10px 0;
      }

      .file-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .file-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
        border-color: #3b82f6;
      }

      .file-card.selected {
        border-color: #3b82f6;
        background: #f8faff;
      }

      .file-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 12px;
        background: #f3f4f6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #6b7280;
      }

      .file-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #1f2937;
      }

      .file-meta {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .file-stats {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #6b7280;
      }

      .file-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .file-card:hover .file-actions {
        opacity: 1;
      }

      .action-btn {
        background: rgba(255,255,255,0.9);
        border: none;
        border-radius: 6px;
        width: 28px;
        height: 28px;
        margin-left: 4px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 14px;
      }

      .action-btn:hover {
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .action-btn.delete {
        color: #dc2626;
      }

      .action-btn.edit {
        color: #3b82f6;
      }

      .action-btn.download {
        color: #059669;
      }

      /* 列表視圖 */
      .files-list {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }

      .files-table {
        width: 100%;
        border-collapse: collapse;
      }

      .files-table thead th {
        background: #f9fafb;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #e5e7eb;
      }

      .files-table tbody tr {
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s;
      }

      .files-table tbody tr:hover {
        background: #f8faff;
      }

      .files-table tbody tr.selected {
        background: #eff6ff;
      }

      .files-table tbody td {
        padding: 12px 16px;
        vertical-align: middle;
      }

      .table-file-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .table-file-icon {
        width: 32px;
        height: 32px;
        background: #f3f4f6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #6b7280;
      }

      .table-file-details {
        flex: 1;
      }

      .table-file-name {
        font-weight: 500;
        font-size: 14px;
        color: #1f2937;
        margin-bottom: 2px;
      }

      .table-file-meta {
        font-size: 12px;
        color: #6b7280;
      }

      .table-actions {
        display: flex;
        gap: 8px;
      }

      /* 空狀態 */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
      }

      .empty-state svg {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
      }

      .empty-state p {
        font-size: 14px;
        margin-bottom: 20px;
      }

      /* 檔案類型圖標 */
      .file-type-pdf { background: #fee2e2; color: #dc2626; }
      .file-type-doc { background: #dbeafe; color: #2563eb; }
      .file-type-xlsx { background: #dcfce7; color: #16a34a; }
      .file-type-image { background: #fef3c7; color: #d97706; }
      .file-type-other { background: #f3f4f6; color: #6b7280; }

      /* 載入動畫 */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* 確認對話框 */
      .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
      }

      .confirm-dialog.show {
        opacity: 1;
        visibility: visible;
      }

      .confirm-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        transform: scale(0.9);
        transition: transform 0.2s;
      }

      .confirm-dialog.show .confirm-content {
        transform: scale(1);
      }

      .confirm-content h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1f2937;
      }

      .confirm-content p {
        color: #6b7280;
        margin-bottom: 20px;
      }

      .confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .confirm-actions button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .confirm-actions .btn-cancel {
        background: #f3f4f6;
        color: #374151;
      }

      .confirm-actions .btn-cancel:hover {
        background: #e5e7eb;
      }

      .confirm-actions .btn-delete {
        background: #dc2626;
        color: white;
      }

      .confirm-actions .btn-delete:hover {
        background: #b91c1c;
      }

      /* Grid utilities */
      .grid {
        display: grid;
      }
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .gap-4 {
        gap: 1rem;
      }

      /* Feature items */
      .feature-item h4 {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
      }
      .feature-list {
        list-style: none;
        padding: 0;
      }
      .feature-list li {
        padding: 0.25rem 0;
        color: #6b7280;
        font-size: 0.875rem;
      }
      .feature-list li:before {
        content: "✓ ";
        color: #10b981;
        font-weight: bold;
        margin-right: 0.5rem;
      }

      /* Card header with button */
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="admin-layout">
      <!-- Sidebar -->
      <nav class="sidebar">
        <div class="sidebar-header">
          <div class="admin-logo-container" style="display: flex; align-items: center; padding: 0 1.5rem 2rem;">
            <img src="/logo.png" alt="Upper Logo" style="height: 2rem; width: auto; margin-right: 0.75rem;">
            <h1 style="font-size: 1.5rem; font-weight: 700; color: #f9fafb; letter-spacing: -0.025em;">Upper</h1>
          </div>
        </div>

        <div class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-section-title">管理</div>
            <a href="#dashboard" class="nav-item active" data-tab="dashboard">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"
                />
              </svg>
              儀表板
            </a>
            <a href="#files" class="nav-item" data-tab="files">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              檔案管理
            </a>
            <a href="#pages" class="nav-item" data-tab="pages">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                />
              </svg>
              下載頁面
            </a>
            <a href="#leads" class="nav-item" data-tab="leads">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                />
              </svg>
              潛在客戶
            </a>
            <a href="#file-creator" class="nav-item" data-tab="file-creator">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                />
              </svg>
              檔案製作
            </a>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <header class="header">
          <h2 id="pageTitle" class="header-title">儀表板</h2>
          <div class="user-menu">
            <div class="user-info">
              <img id="userAvatar" class="user-avatar" src="" alt="用戶頭像" />
              <span id="userName">載入中...</span>
            </div>
            <button class="btn btn-secondary" onclick="logout()">登出</button>
          </div>
        </header>

        <!-- Content -->
        <main class="content">
          <!-- Dashboard Tab -->
          <div id="dashboard-tab" class="tab-content active">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">快速統計</h3>
              </div>
              <div class="card-content">
                <div class="flex gap-2">
                  <div
                    class="card"
                    style="flex: 1; margin: 0; margin-right: 1rem"
                  >
                    <div class="card-content">
                      <div class="text-center">
                        <div
                          id="totalFiles"
                          style="
                            font-size: 2rem;
                            font-weight: bold;
                            color: #3b82f6;
                          "
                        >
                          0
                        </div>
                        <div style="color: #6b7280">檔案總數</div>
                      </div>
                    </div>
                  </div>
                  <div
                    class="card"
                    style="flex: 1; margin: 0; margin-right: 1rem"
                  >
                    <div class="card-content">
                      <div class="text-center">
                        <div
                          id="totalPages"
                          style="
                            font-size: 2rem;
                            font-weight: bold;
                            color: #059669;
                          "
                        >
                          0
                        </div>
                        <div style="color: #6b7280">下載頁數</div>
                      </div>
                    </div>
                  </div>
                  <div
                    class="card"
                    style="flex: 1; margin: 0; margin-right: 1rem"
                  >
                    <div class="card-content">
                      <div class="text-center">
                        <div
                          id="totalDownloads"
                          style="
                            font-size: 2rem;
                            font-weight: bold;
                            color: #dc2626;
                          "
                        >
                          0
                        </div>
                        <div style="color: #6b7280">總下載次數</div>
                      </div>
                    </div>
                  </div>
                  <div class="card" style="flex: 1; margin: 0">
                    <div class="card-content">
                      <div class="text-center">
                        <div
                          id="totalLeads"
                          style="
                            font-size: 2rem;
                            font-weight: bold;
                            color: #f59e0b;
                          "
                        >
                          0
                        </div>
                        <div style="color: #6b7280">收集名單</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title">快速操作</h3>
              </div>
              <div class="card-content">
                <div class="flex gap-2">
                  <button class="btn btn-primary" onclick="switchTab('files')">
                    <svg
                      style="width: 1rem; height: 1rem; margin-right: 0.5rem"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                      />
                    </svg>
                    上傳檔案
                  </button>
                  <button class="btn btn-success" onclick="switchTab('pages')">
                    <svg
                      style="width: 1rem; height: 1rem; margin-right: 0.5rem"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                      />
                    </svg>
                    新增下載頁
                  </button>
                  <button
                    class="btn btn-secondary"
                    onclick="switchTab('analytics')"
                  >
                    <svg
                      style="width: 1rem; height: 1rem; margin-right: 0.5rem"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                      />
                    </svg>
                    查看數據
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Files Tab -->
          <div id="files-tab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">檔案上傳</h3>
              </div>
              <div class="card-content">
                <div id="uploadArea" class="upload-area">
                  <svg
                    style="
                      width: 3rem;
                      height: 3rem;
                      margin: 0 auto 1rem;
                      color: #6b7280;
                    "
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                    />
                  </svg>
                  <p style="font-weight: 500; margin-bottom: 0.5rem">
                    點擊或拖拽檔案到這裡上傳
                  </p>
                  <p style="color: #6b7280; font-size: 0.875rem">
                    支援 PDF, DOC, DOCX, TXT, JPG, PNG, ZIP 等格式
                  </p>
                </div>
                <div id="uploadProgress" class="hidden mt-4">
                  <div
                    style="
                      background: #e5e7eb;
                      border-radius: 0.5rem;
                      height: 0.5rem;
                    "
                  >
                    <div
                      id="progressBar"
                      style="
                        background: #3b82f6;
                        border-radius: 0.5rem;
                        height: 100%;
                        width: 0%;
                        transition: width 0.3s;
                      "
                    ></div>
                  </div>
                  <p
                    id="uploadStatus"
                    class="mt-2 text-center"
                    style="color: #6b7280; font-size: 0.875rem"
                  ></p>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="files-header">
                <h3 class="card-title">我的檔案</h3>
                <div class="files-controls">
                  <div class="view-toggle">
                    <button class="active" onclick="switchFilesView('grid')" data-view="grid">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z"/>
                      </svg>
                      網格
                    </button>
                    <button onclick="switchFilesView('list')" data-view="list">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                      </svg>
                      列表
                    </button>
                  </div>
                  <div class="files-actions">
                    <input type="file" id="fileInput" style="display: none;" multiple>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                        <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                      </svg>
                      上傳檔案
                    </button>
                    <button class="btn btn-primary" onclick="loadFiles()">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                        <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                      </svg>
                      重新整理
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="card-content">
                <div id="filesLoading" class="loading">
                  <div class="spinner"></div>
                </div>

                <!-- 網格視圖 -->
                <div id="filesGrid" class="files-grid" style="display: none;">
                  <!-- 檔案卡片會動態載入 -->
                </div>

                <!-- 列表視圖 -->
                <div id="filesList" class="files-list" style="display: none;">
                  <table class="files-table">
                    <thead>
                      <tr>
                        <th style="width: 40%;">檔案</th>
                        <th style="width: 15%;">大小</th>
                        <th style="width: 15%;">下載次數</th>
                        <th style="width: 15%;">上傳時間</th>
                        <th style="width: 15%;">操作</th>
                      </tr>
                    </thead>
                    <tbody id="filesTableBody"></tbody>
                  </table>
                </div>

                <!-- 空狀態 -->
                <div id="filesEmpty" class="empty-state" style="display: none;">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <h3>還沒有檔案</h3>
                  <p>上傳您的第一個檔案開始使用</p>
                  <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                      <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    上傳檔案
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pages Tab -->
          <div id="pages-tab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">下載頁面管理</h3>
                <button class="btn btn-primary" onclick="showCreatePageModal()">
                  新增頁面
                </button>
              </div>
              <div class="card-content">
                <div id="pagesLoading" class="loading">
                  <div class="spinner"></div>
                </div>
                <div id="pagesList" class="hidden">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>頁面標題</th>
                        <th>關聯檔案</th>
                        <th>瀏覽次數</th>
                        <th>下載次數</th>
                        <th>建立時間</th>
                        <th>狀態</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="pagesTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Leads Tab -->
          <div id="leads-tab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">潛在客戶名單</h3>
                <button class="btn btn-secondary" onclick="exportLeads()">
                  匯出 CSV
                </button>
              </div>
              <div class="card-content">
                <div id="leadsLoading" class="loading">
                  <div class="spinner"></div>
                </div>
                <div id="leadsList" class="hidden">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>電子郵件</th>
                        <th>姓名</th>
                        <th>來源頁面</th>
                        <th>下載檔案</th>
                        <th>提交時間</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="leadsTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- File Creator Tab -->
          <div id="file-creator-tab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">線上檔案製作</h3>
                <button class="btn btn-primary" onclick="window.open('/file-creator.html', '_blank')">
                  開啟檔案製作工具
                </button>
              </div>
              <div class="card-content">
                <p style="color: #6b7280; margin-bottom: 1rem;">
                  直接在瀏覽器中創建各種格式的檔案，支援 TXT、JSON、CSV、HTML、XML、Markdown、PDF 等格式。
                </p>
                <div class="grid grid-cols-2 gap-4">
                  <div class="feature-item">
                    <h4>支援格式</h4>
                    <ul class="feature-list">
                      <li>純文字 (TXT)</li>
                      <li>結構化數據 (JSON, CSV, XML)</li>
                      <li>網頁文件 (HTML)</li>
                      <li>文檔格式 (Markdown, PDF)</li>
                    </ul>
                  </div>
                  <div class="feature-item">
                    <h4>快速模板</h4>
                    <ul class="feature-list">
                      <li>預設模板快速開始</li>
                      <li>即時預覽和編輯</li>
                      <li>自動產生分享頁面</li>
                      <li>檔案統計追蹤</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Create Page Modal -->
    <div id="createPageModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">新增下載頁面</h3>
          <button class="modal-close" onclick="hideCreatePageModal()">
            &times;
          </button>
        </div>
        <form id="createPageForm">
          <div class="form-group">
            <label class="form-label">頁面標題</label>
            <input
              type="text"
              class="form-input"
              name="title"
              required
              placeholder="輸入頁面標題"
            />
          </div>
          <div class="form-group">
            <label class="form-label">頁面描述</label>
            <textarea
              class="form-input form-textarea"
              name="description"
              placeholder="輸入頁面描述"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">關聯檔案</label>
            <select class="form-input" name="fileId" required>
              <option value="">請選擇檔案</option>
            </select>
          </div>
          
          <!-- 圖片管理區域 -->
          <div class="form-group">
            <label class="form-label">頁面圖片</label>
            <div id="createPageImages" class="image-manager">
              <!-- 圖片列表會動態載入 -->
            </div>
            
            <!-- 添加圖片選項 -->
            <div class="image-add-options">
              <div class="flex gap-2 mb-4">
                <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUploadOption('create')">
                  📁 上傳圖片
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUrlOption('create')">
                  🔗 圖片網址
                </button>
              </div>
              
              <!-- 上傳圖片區域 -->
              <div id="createImageUploadArea" class="image-upload-area hidden">
                <input type="file" id="createImageUpload" multiple accept="image/*" class="form-input">
                <div class="upload-preview" id="createUploadPreview"></div>
              </div>
              
              <!-- 圖片網址區域 -->
              <div id="createImageUrlArea" class="image-url-area hidden">
                <div class="flex gap-2">
                  <input type="url" id="createImageUrl" placeholder="輸入圖片網址" class="form-input">
                  <button type="button" class="btn btn-primary btn-sm" onclick="addImageUrl('create')">添加</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">收集電子郵件</label>
            <select class="form-input" name="requireEmail">
              <option value="true">是 - 需要輸入電子郵件才能下載</option>
              <option value="false">否 - 直接下載</option>
            </select>
          </div>
          <div class="flex gap-2 justify-between">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="hideCreatePageModal()"
            >
              取消
            </button>
            <button type="submit" class="btn btn-primary">建立頁面</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Page Modal -->
    <div id="editPageModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">編輯下載頁面</h3>
          <button class="modal-close" onclick="hideEditPageModal()">
            &times;
          </button>
        </div>
        <form id="editPageForm">
          <div class="form-group">
            <label class="form-label">頁面標題</label>
            <input
              type="text"
              class="form-input"
              id="editPageTitle"
              name="title"
              required
              placeholder="輸入頁面標題"
            />
          </div>
          <div class="form-group">
            <label class="form-label">頁面描述</label>
            <textarea
              class="form-input form-textarea"
              id="editPageDescription"
              name="description"
              placeholder="輸入頁面描述"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">關聯檔案</label>
            <select class="form-input" id="editPageFileId" name="fileId">
              <option value="">選擇檔案 (可選)</option>
            </select>
          </div>
          
          <!-- 圖片管理區域 -->
          <div class="form-group">
            <label class="form-label">頁面圖片</label>
            <div id="editPageImages" class="image-manager">
              <!-- 圖片列表會動態載入 -->
            </div>
            
            <!-- 添加圖片選項 -->
            <div class="image-add-options">
              <div class="flex gap-2 mb-4">
                <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUploadOption('edit')">
                  📁 上傳圖片
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUrlOption('edit')">
                  🔗 圖片網址
                </button>
              </div>
              
              <!-- 上傳圖片區域 -->
              <div id="editImageUploadArea" class="image-upload-area hidden">
                <input type="file" id="editImageUpload" multiple accept="image/*" class="form-input">
                <div class="upload-preview" id="editUploadPreview"></div>
              </div>
              
              <!-- 圖片網址區域 -->
              <div id="editImageUrlArea" class="image-url-area hidden">
                <div class="flex gap-2">
                  <input type="url" id="editImageUrl" placeholder="輸入圖片網址" class="form-input">
                  <button type="button" class="btn btn-primary btn-sm" onclick="addImageUrl('edit')">添加</button>
                </div>
              </div>
            </div>
          </div>
          <div class="flex gap-2 justify-between">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="hideEditPageModal()"
            >
              取消
            </button>
            <button type="submit" class="btn btn-primary">更新頁面</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Global variables
      let currentUser = null;
      let currentFiles = [];
      let currentView = 'grid';
      let accessToken = localStorage.getItem('accessToken') || localStorage.getItem('authToken') || localStorage.getItem('adminToken');
      let refreshToken = null;
      let deleteFileId = null;

      // 檔案類型圖標配置
      const fileTypeIcons = {
        'pdf': { icon: '📄', class: 'file-type-pdf' },
        'doc': { icon: '📝', class: 'file-type-doc' },
        'docx': { icon: '📝', class: 'file-type-doc' },
        'xls': { icon: '📊', class: 'file-type-xlsx' },
        'xlsx': { icon: '📊', class: 'file-type-xlsx' },
        'ppt': { icon: '📽️', class: 'file-type-other' },
        'pptx': { icon: '📽️', class: 'file-type-other' },
        'txt': { icon: '📄', class: 'file-type-other' },
        'jpg': { icon: '🖼️', class: 'file-type-image' },
        'jpeg': { icon: '🖼️', class: 'file-type-image' },
        'png': { icon: '🖼️', class: 'file-type-image' },
        'gif': { icon: '🖼️', class: 'file-type-image' },
        'zip': { icon: '🗜️', class: 'file-type-other' },
        'rar': { icon: '🗜️', class: 'file-type-other' },
        'default': { icon: '📄', class: 'file-type-other' }
      };

      // 載入檔案列表
      async function loadFiles() {
        console.log('loadFiles called');
        const loadingEl = document.getElementById('filesLoading');
        const gridEl = document.getElementById('filesGrid');
        const listEl = document.getElementById('filesList');
        const emptyEl = document.getElementById('filesEmpty');
        
        console.log('DOM elements:', { loadingEl, gridEl, listEl, emptyEl });
        
        // 檢查是否已登入
        if (!accessToken) {
          console.log('No access token found');
          showLoginRequired();
          return;
        }
        
        // 顯示載入狀態
        if (loadingEl) loadingEl.style.display = 'block';
        if (gridEl) gridEl.style.display = 'none';
        if (listEl) listEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'none';
        
        try {
          console.log('Making API request with token:', accessToken ? 'exists' : 'missing');
          const response = await fetch('/api/files', {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          console.log('API response status:', response.status);
          
          if (response.status === 401) {
            console.log('Authentication failed - token expired or invalid');
            // 清除無效的 token
            clearAuthData();
            showLoginRequired();
            return;
          }
          
          if (response.ok) {
            const data = await response.json();
            console.log('API response data:', data);
            currentFiles = data.files || [];
            console.log('currentFiles length:', currentFiles.length);
            
            // 隱藏載入狀態
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (currentFiles.length === 0) {
              console.log('No files, showing empty state');
              if (emptyEl) emptyEl.style.display = 'block';
            } else {
              console.log('Files found, currentView:', currentView);
              // 根據當前視圖顯示對應內容
              if (currentView === 'grid') {
                console.log('Showing grid view');
                if (gridEl) gridEl.style.display = 'grid';
              } else {
                console.log('Showing list view');
                if (listEl) listEl.style.display = 'block';
              }
              renderFiles();
            }
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          console.error('Load files error:', error);
          if (loadingEl) loadingEl.style.display = 'none';
          
          // 顯示錯誤信息
          if (emptyEl) {
            emptyEl.style.display = 'block';
            emptyEl.innerHTML = `
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <h3>載入失敗</h3>
              <p>無法載入檔案列表：${error.message}</p>
              <button class="btn btn-primary" onclick="loadFiles()">重新載入</button>
            `;
          }
        }
      }

      // 顯示需要登入的提示
      function showLoginRequired() {
        const loadingEl = document.getElementById('filesLoading');
        const gridEl = document.getElementById('filesGrid');
        const listEl = document.getElementById('filesList');
        const emptyEl = document.getElementById('filesEmpty');
        
        // 隱藏其他元素
        if (loadingEl) loadingEl.style.display = 'none';
        if (gridEl) gridEl.style.display = 'none';
        if (listEl) listEl.style.display = 'none';
        
        // 顯示登入提示
        if (emptyEl) {
          emptyEl.style.display = 'block';
          emptyEl.innerHTML = `
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
            </svg>
            <h3>需要登入</h3>
            <p>請先登入才能查看和管理檔案</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <button class="btn btn-primary" onclick="window.open('/quick-login.html', '_blank')">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                  <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                </svg>
                快速登入
              </button>
              <button class="btn btn-secondary" onclick="loadFiles()">重新檢查</button>
            </div>
          `;
        }
        
        // 更新用戶狀態顯示
        updateUserStatus(false);
      }

      // 清除認證數據
      function clearAuthData() {
        accessToken = null;
        refreshToken = null;
        currentUser = null;
        localStorage.removeItem('accessToken');
        localStorage.removeItem('authToken');
        localStorage.removeItem('adminToken');
        localStorage.removeItem('refreshToken');
      }

      // 更新用戶狀態顯示
      function updateUserStatus(isLoggedIn, user = null) {
        const userInfo = document.querySelector('.user-info');
        if (!userInfo) return;
        
        if (isLoggedIn && user) {
          userInfo.style.display = 'flex';
          userInfo.innerHTML = `
            <img src="${user.avatar}" alt="${user.name}" class="user-avatar">
            <div class="user-details">
              <div class="user-name">${user.name}</div>
              <div class="user-email">${user.email}</div>
            </div>
            <div class="user-menu">
              <button onclick="logout()" class="btn btn-secondary">登出</button>
            </div>
          `;
        } else {
          userInfo.style.display = 'flex';
          userInfo.innerHTML = `
            <div class="user-details">
              <div class="user-name">未登入</div>
              <div class="user-email">請登入以管理檔案</div>
            </div>
            <div class="user-menu">
              <button onclick="window.open('/quick-login.html', '_blank')" class="btn btn-primary">登入</button>
            </div>
          `;
        }
      }

      // 登出函數
      function logout() {
        clearAuthData();
        showLoginRequired();
        updateUserStatus(false);
      }

      // 切換檔案視圖
      function switchFilesView(view) {
        currentView = view;
        
        // 更新按鈕狀態
        document.querySelectorAll('.view-toggle button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        // 切換視圖
        if (view === 'grid') {
          document.getElementById('filesGrid').style.display = 'grid';
          document.getElementById('filesList').style.display = 'none';
        } else {
          document.getElementById('filesGrid').style.display = 'none';
          document.getElementById('filesList').style.display = 'block';
        }
        
        renderFiles();
      }

      // 工具函數

      // 獲取檔案類型圖標
      function getFileTypeIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        return fileTypeIcons[extension] || fileTypeIcons.default;
      }

      // 格式化檔案大小
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // 格式化日期
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
      }

      // 渲染函數
      function renderFiles() {
        console.log('renderFiles called, currentView:', currentView, 'currentFiles:', currentFiles.length);
        console.log('Current files data:', currentFiles);
        if (currentView === 'grid') {
          renderFilesGrid();
        } else {
          renderFilesList();
        }
      }

      // 渲染網格視圖
      function renderFilesGrid() {
        console.log('renderFilesGrid called');
        const container = document.getElementById('filesGrid');
        console.log('Grid container found:', !!container);
        console.log('Current files count:', currentFiles.length);
        console.log('Files data:', currentFiles);
        
        if (!container) {
          console.error('Grid container not found!');
          return;
        }
        
        if (currentFiles.length === 0) {
          console.log('No files to display');
          container.innerHTML = '';
          return;
        }
        
        console.log('Starting to generate HTML for files...');
        const html = currentFiles.map((file, index) => {
          console.log(`Processing file ${index}:`, file);
          const typeInfo = getFileTypeIcon(file.name);
          console.log(`File type info for ${file.name}:`, typeInfo);
          return `
            <div class="file-card" data-file-id="${file.id}">
              <div class="file-actions">
                <button class="action-btn download" onclick="downloadFile('${file.downloadSlug}')" title="下載">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                  </svg>
                </button>
                <button class="action-btn edit" onclick="editFile('${file.id}')" title="編輯">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                  </svg>
                </button>
                <button class="action-btn delete" onclick="showDeleteConfirm('${file.id}', '${file.name}')" title="刪除">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                </button>
              </div>
              <div class="file-icon ${typeInfo.class}">
                ${typeInfo.icon}
              </div>
              <div class="file-name" title="${file.name}">${file.name}</div>
              <div class="file-meta">${formatFileSize(file.sizeBytes)}</div>
              <div class="file-stats">
                <span>${file.downloads} 次下載</span>
                <span class="file-status ${file.isActive ? 'active' : 'inactive'}">
                  ${file.isActive ? '啟用' : '停用'}
                </span>
              </div>
            </div>
          `;
        }).join('');
        
        console.log('Generated HTML length:', html.length);
        console.log('Generated HTML preview:', html.substring(0, 200) + '...');
        container.innerHTML = html;
        console.log('HTML set to container, container children count:', container.children.length);
      }

      // 渲染列表視圖
      function renderFilesList() {
        const tbody = document.getElementById('filesTableBody');
        
        if (currentFiles.length === 0) {
          tbody.innerHTML = '';
          return;
        }
        
        const html = currentFiles.map(file => {
          const typeInfo = getFileTypeIcon(file.name);
          return `
            <tr data-file-id="${file.id}">
              <td>
                <div class="table-file-info">
                  <div class="table-file-icon ${typeInfo.class}">
                    ${typeInfo.icon}
                  </div>
                  <div class="table-file-details">
                    <div class="table-file-name">${file.name}</div>
                    <div class="table-file-meta">${file.originalName}</div>
                  </div>
                </div>
              </td>
              <td>${formatFileSize(file.sizeBytes)}</td>
              <td>${file.downloads}</td>
              <td>${formatDate(file.createdAt)}</td>
              <td>
                <div class="table-actions">
                  <button class="action-btn download" onclick="downloadFile('${file.downloadSlug}')" title="下載">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                    </svg>
                  </button>
                  <button class="action-btn edit" onclick="editFile('${file.id}')" title="編輯">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <button class="action-btn delete" onclick="showDeleteConfirm('${file.id}', '${file.name}')" title="刪除">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.innerHTML = html;
      }

      // 選項卡導航功能
      function initTabNavigation() {
        // 獲取所有導航項目
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        navItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            
            const tabId = item.getAttribute('data-tab');
            
            // 移除所有活動狀態
            navItems.forEach(nav => nav.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // 添加當前活動狀態
            item.classList.add('active');
            const targetContent = document.getElementById(tabId + '-tab');
            if (targetContent) {
              targetContent.classList.add('active');
            }
            
            // 如果切換到檔案選項卡，載入檔案列表
            if (tabId === 'files') {
              loadFiles();
            }
          });
        });
      }
      let pages = [];
      let leads = [];

      // Handle OAuth callback
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get("token")) {
        accessToken = urlParams.get("token");
        const refreshToken = urlParams.get("refreshToken");

        localStorage.setItem("accessToken", accessToken);
        if (refreshToken) {
          localStorage.setItem("refreshToken", refreshToken);
        }

        // Clean URL
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );
      }

      // Initialize
      async function init() {
        try {
          // Try to get token from localStorage first - check multiple possible keys
          if (!accessToken) {
            accessToken = localStorage.getItem('accessToken') || 
                        localStorage.getItem('authToken') || 
                        localStorage.getItem('adminToken');
          }
          
          // Log the token status for debugging
          console.log('Access token status:', accessToken ? 'Found' : 'Not found');
          
          // Check if we have a token
          if (!accessToken) {
            console.log('No token found, showing login required');
            updateUserStatus(false);
            showLoginRequired();
            return;
          }
          
          // Try to get current user to validate token
          try {
            currentUser = await getCurrentUser();
            if (currentUser) {
              console.log('User authenticated:', currentUser);
              updateUserStatus(true, currentUser);
              
              // 初始化應用功能
              initTabNavigation();
              setupFileUpload();
              
              // 切換到檔案選項卡並載入檔案
              switchTab('files');
            } else {
              throw new Error('Invalid user data');
            }
          } catch (authError) {
            console.log('Authentication failed:', authError);
            // Token might be expired, clear it and show login
            clearAuthData();
            updateUserStatus(false);
            showLoginRequired();
          }
          
        } catch (error) {
          console.error("Initialization error:", error);
          clearAuthData();
          updateUserStatus(false);
          showLoginRequired();
        }
      }
      
      // Helper function to show login UI
      function showLoginUI() {
        document.querySelector('.user-info').style.display = 'none';
        const logoutBtn = document.querySelector('.user-menu button[onclick="logout()"]');
        if (logoutBtn) {
          logoutBtn.style.display = 'none';
        }
        
        // Remove any existing login button first
        const existingLoginBtn = document.querySelector('.user-menu .login-button');
        if (existingLoginBtn) {
          existingLoginBtn.remove();
        }
        
        // Create login options container
        const loginContainer = document.createElement('div');
        loginContainer.className = 'login-button';
        loginContainer.innerHTML = `
          <button class="btn btn-primary" onclick="window.location.href='/'">
            OAuth 登入
          </button>
        `;
        
        document.querySelector('.user-menu').appendChild(loginContainer);
      }
      
      // Helper function to clear auth data
      function clearAuthData() {
        localStorage.removeItem("accessToken");
        localStorage.removeItem("authToken");
        localStorage.removeItem("adminToken");
        localStorage.removeItem("refreshToken");
        localStorage.removeItem("user");
        accessToken = null;
      }

      // Authentication
      async function getCurrentUser() {
        try {
          // Check if we have a mock user from dev login
          const mockUser = localStorage.getItem("user");
          if (mockUser) {
            const user = JSON.parse(mockUser);
            if (user.provider === "dev-mock") {
              return user;
            }
          }

          // Try real API for OAuth users
          const response = await fetch("/api/auth/me", {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            return data.user;
          }
          return null;
        } catch (error) {
          console.error("Failed to get user:", error);
          // Check if we have mock user as fallback
          const mockUser = localStorage.getItem("user");
          if (mockUser) {
            const user = JSON.parse(mockUser);
            if (user.provider === "dev-mock") {
              return user;
            }
          }
          return null;
        }
      }

      function updateUserInfo() {
        document.getElementById("userName").textContent = currentUser.name;
        // Use a simple local avatar or background color instead of external HTTPS API
        const avatar = currentUser.avatar || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%233b82f6'/%3E%3Ctext x='20' y='26' text-anchor='middle' fill='white' font-size='16' font-family='Arial'%3E" + (currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U') + "%3C/text%3E%3C/svg%3E";
        document.getElementById("userAvatar").src = avatar;
      }

      async function logout() {
        try {
          await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
        } catch (error) {
          console.error('Logout error:', error);
        } finally {
          clearAuthData();
          window.location.href = "/";
        }
      }

      // 移除內嵌的開發登入函數，統一使用 dev-login.html

      // Tab Management
      function switchTab(tabName) {
        // Update navigation
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active");

        // Update content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`${tabName}-tab`).classList.add("active");

        // Update title
        const titles = {
          dashboard: "儀表板",
          files: "檔案管理",
          pages: "下載頁面",
          leads: "潛在客戶",
          "file-creator": "檔案製作",
        };
        document.getElementById("pageTitle").textContent = titles[tabName];

        // Load content
        switch (tabName) {
          case "dashboard":
            loadDashboard();
            break;
          case "files":
            loadFiles();
            break;
          case "pages":
            loadPages();
            break;
          case "leads":
            loadLeads();
            break;
        }
      }

      // Navigation event listeners
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const tab = item.getAttribute("data-tab");
          switchTab(tab);
        });
      });

      // Dashboard
      async function loadDashboard() {
        console.log("Loading dashboard statistics...");
        
        try {
          // Get token from localStorage
          const token = localStorage.getItem('accessToken') || 
                       localStorage.getItem('authToken') || 
                       localStorage.getItem('adminToken');
          
          if (!token) {
            console.error('No authentication token found');
            return;
          }
          
          // Get analytics data
          const response = await fetch('/api/analytics', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            const analytics = data.data.overview;
            
            // Update dashboard statistics
            document.getElementById('totalFiles').textContent = analytics.totalFiles || 0;
            document.getElementById('totalPages').textContent = analytics.totalPages || 0;
            document.getElementById('totalDownloads').textContent = analytics.totalDownloads || 0;
            document.getElementById('totalLeads').textContent = analytics.totalLeads || 0;
            
            console.log('Dashboard statistics loaded successfully:', analytics);
          } else {
            console.error('Failed to load dashboard statistics:', response.status, response.statusText);
            // Keep default 0 values on error
          }
        } catch (error) {
          console.error('Error loading dashboard statistics:', error);
        }
      }

      // File Management
      function setupFileUpload() {
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");

        uploadArea.addEventListener("click", () => {
          fileInput.click();
        });

        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
          const files = Array.from(e.dataTransfer.files);
          uploadFiles(files);
        });

        fileInput.addEventListener("change", (e) => {
          const files = Array.from(e.target.files);
          uploadFiles(files);
        });
      }

      async function uploadFiles(fileList) {
        const progressContainer = document.getElementById("uploadProgress");
        const progressBar = document.getElementById("progressBar");
        const statusText = document.getElementById("uploadStatus");

        progressContainer.classList.remove("hidden");
        
        // 防止重複上傳 - 禁用上傳區域
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");
        uploadArea.style.pointerEvents = 'none';
        uploadArea.style.opacity = '0.6';
        if (fileInput) fileInput.disabled = true;

        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < fileList.length; i++) {
          const file = fileList[i];
          statusText.textContent = `正在上傳: ${file.name} (${i + 1}/${fileList.length})`;

          try {
            const formData = new FormData();
            formData.append("file", file);

            const response = await fetch("/api/files", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
              body: formData,
            });

            if (response.ok) {
              const result = await response.json();
              if (result.message === "File already exists") {
                console.log(`檔案已存在: ${file.name}`);
              } else {
                successCount++;
              }
              const progress = ((i + 1) / fileList.length) * 100;
              progressBar.style.width = `${progress}%`;
            } else {
              failCount++;
              const errorText = await response.text();
              let errorData;
              try {
                errorData = JSON.parse(errorText);
              } catch {
                errorData = { error: errorText };
              }
              
              // Check for token expiration
              if (response.status === 401 && errorData.error === "Token expired") {
                clearAuthData();
                alert("登入已過期，請重新登入");
                window.location.href = "/dev-login.html?returnTo=/admin.html";
                return;
              }
              
              console.error(`Upload failed for ${file.name}:`, errorData);
              statusText.textContent = `上傳失敗: ${file.name} - ${errorData.error || errorText}`;
              
              // 給用戶一些時間看到錯誤信息
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          } catch (error) {
            failCount++;
            console.error("Upload error:", error);
            statusText.textContent = `上傳失敗: ${file.name} - ${error.message}`;
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }

        // 顯示最終結果
        if (failCount === 0) {
          statusText.textContent = `上傳完成！成功上傳 ${successCount} 個檔案`;
        } else {
          statusText.textContent = `上傳完成：${successCount} 成功，${failCount} 失敗`;
        }
        
        // 重新啟用上傳區域並重置進度條
        setTimeout(() => {
          progressContainer.classList.add("hidden");
          progressBar.style.width = "0%";
          uploadArea.style.pointerEvents = '';
          uploadArea.style.opacity = '';
          if (fileInput) {
            fileInput.disabled = false;
            fileInput.value = ''; // 清空檔案選擇
          }
        }, 2000);
        
        // 重新載入檔案列表
        await loadFiles();
      }



      // Page Management
      async function loadPages() {
        const loading = document.getElementById("pagesLoading");
        const list = document.getElementById("pagesList");
        const tbody = document.getElementById("pagesTableBody");

        loading.classList.remove("hidden");
        list.classList.add("hidden");

        try {
          const response = await fetch("/api/pages", {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            pages = data.pages || [];

            tbody.innerHTML = pages
              .map(
                (page) => `
              <tr>
                <td>${page.title}</td>
                <td>${page.file ? page.file.originalName : "無"}</td>
                <td>${page.views || 0}</td>
                <td>${page.downloads || 0}</td>
                <td>${formatDate(page.createdAt)}</td>
                <td><span class="badge ${
                  page.isActive ? "badge-success" : "badge-warning"
                }">${page.isActive ? "啟用" : "停用"}</span></td>
                <td>
                  <button class="btn btn-secondary" onclick="viewPage('${
                    page.slug
                  }')">預覽</button>
                  <button class="btn btn-secondary" onclick="copyPageUrl('${
                    page.slug
                  }')">複製連結</button>
                  <button class="btn btn-primary" onclick="editPage('${
                    page.id
                  }')">編輯</button>
                  <button class="btn btn-danger" onclick="deletePage('${
                    page.id
                  }')">刪除</button>
                </td>
              </tr>
            `
              )
              .join("");

            list.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Failed to load pages:", error);
        } finally {
          loading.classList.add("hidden");
        }
      }

      async function showCreatePageModal() {
        // Populate file options
        const fileSelect = document.querySelector(
          '#createPageModal select[name="fileId"]'
        );
        
        // First, ensure we have the latest files list
        if (currentFiles.length === 0) {
          try {
            const response = await fetch('/api/files', {
              headers: {
                'Authorization': `Bearer ${accessToken}`,
              },
            });
            
            if (response.ok) {
              const data = await response.json();
              currentFiles = data.files || [];
            }
          } catch (error) {
            console.error('Failed to load files for modal:', error);
          }
        }
        
        // Populate file options using currentFiles
        fileSelect.innerHTML =
          '<option value="">請選擇檔案</option>' +
          currentFiles
            .map(
              (file) =>
                `<option value="${file.id}">${file.originalName || file.name}</option>`
            )
            .join("");

        // Reset image manager
        pageImages.create = [];
        updateImageManager('create');
        
        document.getElementById("createPageModal").classList.add("show");
      }

      function hideCreatePageModal() {
        document.getElementById("createPageModal").classList.remove("show");
      }

      // Lead Management
      async function loadLeads() {
        const loading = document.getElementById("leadsLoading");
        const list = document.getElementById("leadsList");
        const tbody = document.getElementById("leadsTableBody");

        loading.classList.remove("hidden");
        list.classList.add("hidden");

        try {
          const response = await fetch("/api/analytics/leads", {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            leads = data.leads || [];

            tbody.innerHTML = leads
              .map(
                (lead) => `
              <tr>
                <td>${lead.email}</td>
                <td>${lead.name || "未提供"}</td>
                <td>${lead.page ? lead.page.title : "未知"}</td>
                <td>${lead.file ? lead.file.originalName : "未知"}</td>
                <td>${formatDate(lead.createdAt)}</td>
                <td>
                  <button class="btn btn-secondary" onclick="exportSingleLead('${
                    lead.id
                  }')">匯出</button>
                </td>
              </tr>
            `
              )
              .join("");

            list.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Failed to load leads:", error);
        } finally {
          loading.classList.add("hidden");
        }
      }

      // Utility functions
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return (
          date.toLocaleDateString("zh-TW") +
          " " +
          date.toLocaleTimeString("zh-TW")
        );
      }

      // Page management functions
      function viewPage(slug) {
        // Open preview page in new tab
        window.open(`/download-page/${slug}`, '_blank');
      }

      // 複製頁面連結
      function copyPageUrl(slug) {
        const url = `${window.location.origin}/download-page/${slug}`;
        
        if (navigator.clipboard && window.isSecureContext) {
          // 使用現代剪貼簿 API
          navigator.clipboard.writeText(url).then(() => {
            showCopyNotification('頁面連結已複製到剪貼簿');
          }).catch(err => {
            console.error('Failed to copy: ', err);
            fallbackCopyTextToClipboard(url);
          });
        } else {
          // 備用方案
          fallbackCopyTextToClipboard(url);
        }
      }

      // 備用複製方案
      function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        
        // 避免在iOS中縮放
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          const successful = document.execCommand('copy');
          const msg = successful ? '頁面連結已複製到剪貼簿' : '複製失敗，請手動複製';
          showCopyNotification(msg);
        } catch (err) {
          console.error('Fallback: Oops, unable to copy', err);
          showCopyNotification('複製失敗，請手動複製');
        }

        document.body.removeChild(textArea);
      }

      // 顯示複製通知
      function showCopyNotification(message) {
        // 創建通知元素
        const notification = document.createElement('div');
        notification.className = 'copy-notification';
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #10b981;
          color: white;
          padding: 12px 20px;
          border-radius: 6px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          z-index: 9999;
          font-size: 14px;
          font-weight: 500;
          transition: all 0.3s ease;
          opacity: 0;
          transform: translateY(-10px);
        `;
        
        document.body.appendChild(notification);
        
        // 觸發動畫
        setTimeout(() => {
          notification.style.opacity = '1';
          notification.style.transform = 'translateY(0)';
        }, 10);
        
        // 3秒後移除
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      function editPage(pageId) {
        // Find the page data
        const page = pages.find(p => p.id === parseInt(pageId));
        if (!page) {
          alert('頁面不存在');
          return;
        }

        // Populate edit form
        document.getElementById('editPageTitle').value = page.title;
        document.getElementById('editPageDescription').value = page.description || '';
        
        // Set file selection
        const fileSelect = document.getElementById('editPageFileId');
        fileSelect.value = page.fileId || '';

        // 載入頁面圖片資料
        pageImages.edit = [];
        if (page.images) {
          try {
            const images = JSON.parse(page.images);
            pageImages.edit = images.map(url => ({
              type: 'url',
              url: url,
              preview: url
            }));
          } catch (error) {
            console.error('解析圖片資料失敗:', error);
          }
        }
        
        // 更新圖片管理器顯示
        updateImageManager('edit');

        // Store page ID for update
        editingPageId = pageId;

        // Show edit modal
        showEditPageModal();
      }

      function deletePage(pageId) {
        if (!confirm('確定要刪除這個頁面嗎？此操作無法復原。')) {
          return;
        }

        fetch(`/api/pages/${pageId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
          },
        })
        .then(response => {
          if (response.ok) {
            alert('頁面已刪除');
            loadPages();
          } else {
            alert('刪除失敗，請稍後重試');
          }
        })
        .catch(error => {
          console.error('Delete error:', error);
          alert('刪除失敗，請稍後重試');
        });
      }

      // Edit modal functions
      let editingPageId = null;

      function showEditPageModal() {
        document.getElementById('editPageModal').classList.add('show');
        loadFilesForEdit(); // Load files for selection
      }

      function hideEditPageModal() {
        document.getElementById('editPageModal').classList.remove('show');
        editingPageId = null;
      }

      async function loadFilesForEdit() {
        try {
          const response = await fetch('/api/files', {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            const fileSelect = document.getElementById('editPageFileId');
            
            fileSelect.innerHTML = '<option value="">選擇檔案 (可選)</option>';
            data.files.forEach(file => {
              const option = document.createElement('option');
              option.value = file.id;
              option.textContent = file.originalName;
              fileSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Load files error:', error);
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        setupFileUpload();
        init();
      });

      // Form submission
      document
        .getElementById("createPageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const pageData = Object.fromEntries(formData);

          try {
            // 先上傳圖片
            const imageUrls = await uploadImages('create');
            if (imageUrls === null) return; // 圖片上傳失敗
            
            // 添加圖片到頁面數據
            pageData.images = JSON.stringify(imageUrls);

            const response = await fetch("/api/pages", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(pageData),
            });

            if (response.ok) {
              hideCreatePageModal();
              loadPages();
              // 清空圖片列表
              pageImages.create = [];
              updateImageManager('create');
              alert("頁面建立成功！");
            } else {
              alert("建立失敗，請稍後重試");
            }
          } catch (error) {
            console.error("Create page error:", error);
            alert("建立失敗，請稍後重試");
          }
        });

      // Edit Page Form submission
      document
        .getElementById("editPageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          
          if (!editingPageId) {
            alert("無效的頁面ID");
            return;
          }

          const formData = new FormData(e.target);
          const updateData = Object.fromEntries(formData);

          // Remove empty fileId
          if (!updateData.fileId) {
            updateData.fileId = null;
          }

          try {
            // 先上傳圖片
            const imageUrls = await uploadImages('edit');
            if (imageUrls === null) return; // 圖片上傳失敗
            
            // 添加圖片到更新數據
            updateData.images = JSON.stringify(imageUrls);

            const response = await fetch(`/api/pages/${editingPageId}`, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updateData),
            });

            if (response.ok) {
              hideEditPageModal();
              loadPages();
              alert("頁面更新成功！");
            } else {
              const errorData = await response.json();
              alert(`更新失敗：${errorData.message || '請稍後重試'}`);
            }
          } catch (error) {
            console.error("Update page error:", error);
            alert("更新失敗，請稍後重試");
          }
        });

      // Image Management Functions
      let pageImages = { create: [], edit: [] };

      function showImageUploadOption(mode) {
        const uploadArea = document.getElementById(`${mode}ImageUploadArea`);
        uploadArea.classList.remove('hidden');
        document.getElementById(`${mode}ImageUrlArea`).classList.add('hidden');
        
        // 綁定文件上傳事件
        const uploadInput = document.getElementById(`${mode}ImageUpload`);
        uploadInput.onchange = function(e) {
          handleImageUpload(e, mode);
        };
        
        // 添加拖拽功能
        setupDragAndDrop(uploadArea, mode);
      }

      function showImageUrlOption(mode) {
        document.getElementById(`${mode}ImageUrlArea`).classList.remove('hidden');
        document.getElementById(`${mode}ImageUploadArea`).classList.add('hidden');
      }

      // 設置拖拽上傳功能
      function setupDragAndDrop(uploadArea, mode) {
        // 防止預設的拖拽行為
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // 高亮拖拽區域
        ['dragenter', 'dragover'].forEach(eventName => {
          uploadArea.addEventListener(eventName, () => highlight(uploadArea), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, () => unhighlight(uploadArea), false);
        });
        
        // 處理檔案放置
        uploadArea.addEventListener('drop', (e) => handleDrop(e, mode), false);
      }
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      function highlight(uploadArea) {
        uploadArea.style.borderColor = '#3b82f6';
        uploadArea.style.backgroundColor = '#eff6ff';
        uploadArea.style.borderStyle = 'solid';
      }
      
      function unhighlight(uploadArea) {
        uploadArea.style.borderColor = '#d1d5db';
        uploadArea.style.backgroundColor = 'white';
        uploadArea.style.borderStyle = 'dashed';
      }
      
      function handleDrop(e, mode) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        // 過濾只保留圖片檔案
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
        
        if (imageFiles.length === 0) {
          alert('請只上傳圖片檔案 (JPG, PNG, GIF 等)');
          return;
        }
        
        // 處理拖拽的圖片檔案
        processDraggedImages(imageFiles, mode);
      }
      
      function processDraggedImages(files, mode) {
        const preview = document.getElementById(`${mode}UploadPreview`);
        
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            preview.appendChild(img);
            
            // 添加到圖片列表
            pageImages[mode].push({
              type: 'upload',
              file: file,
              preview: e.target.result
            });
            
            // 更新圖片管理器
            updateImageManager(mode);
          };
          reader.readAsDataURL(file);
        });
      }

      function handleImageUpload(event, mode) {
        const files = event.target.files;
        const preview = document.getElementById(`${mode}UploadPreview`);
        preview.innerHTML = '';

        for (let file of files) {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              preview.appendChild(img);
              
              // 添加到圖片列表
              pageImages[mode].push({
                type: 'upload',
                file: file,
                preview: e.target.result
              });
            };
            reader.readAsDataURL(file);
          }
        }
        
        updateImageManager(mode);
      }

      function addImageUrl(mode) {
        const urlInput = document.getElementById(`${mode}ImageUrl`);
        const url = urlInput.value.trim();
        
        if (url) {
          // 驗證圖片URL
          const img = new Image();
          img.onload = function() {
            pageImages[mode].push({
              type: 'url',
              url: url,
              preview: url
            });
            updateImageManager(mode);
            urlInput.value = '';
          };
          img.onerror = function() {
            alert('無法載入圖片，請檢查網址是否正確');
          };
          img.src = url;
        }
      }

      function updateImageManager(mode) {
        const container = document.getElementById(`${mode}PageImages`);
        
        if (pageImages[mode].length === 0) {
          container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">尚未添加圖片</p>';
          return;
        }

        const imageList = document.createElement('div');
        imageList.className = 'image-list';

        pageImages[mode].forEach((image, index) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';
          
          imageItem.innerHTML = `
            <img src="${image.preview}" alt="圖片 ${index + 1}">
            <div class="image-item-controls">
              <button type="button" class="image-btn" onclick="moveImage('${mode}', ${index}, -1)" title="向前移動">↑</button>
              <button type="button" class="image-btn" onclick="moveImage('${mode}', ${index}, 1)" title="向後移動">↓</button>
              <button type="button" class="image-btn" onclick="removeImage('${mode}', ${index})" title="刪除">×</button>
            </div>
          `;
          
          imageList.appendChild(imageItem);
        });

        container.innerHTML = '';
        container.appendChild(imageList);
        
        // 添加圖片數量提示
        const info = document.createElement('p');
        info.style.color = '#6b7280';
        info.style.fontSize = '0.875rem';
        info.style.marginTop = '0.5rem';
        info.textContent = `已添加 ${pageImages[mode].length} 張圖片${pageImages[mode].length > 1 ? '（將顯示為輪播圖）' : ''}`;
        container.appendChild(info);
      }

      function moveImage(mode, index, direction) {
        const images = pageImages[mode];
        const newIndex = index + direction;
        
        if (newIndex >= 0 && newIndex < images.length) {
          [images[index], images[newIndex]] = [images[newIndex], images[index]];
          updateImageManager(mode);
        }
      }

      function removeImage(mode, index) {
        if (confirm('確定要刪除這張圖片嗎？')) {
          pageImages[mode].splice(index, 1);
          updateImageManager(mode);
        }
      }

      async function uploadImages(mode) {
        const uploadedUrls = [];
        
        for (const image of pageImages[mode]) {
          if (image.type === 'upload') {
            const formData = new FormData();
            formData.append('images', image.file);
            
            try {
              const response = await fetch('/api/upload-images', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                },
                body: formData
              });
              
              if (response.ok) {
                const result = await response.json();
                uploadedUrls.push(result.urls[0]);
              } else {
                throw new Error('圖片上傳失敗');
              }
            } catch (error) {
              console.error('Image upload error:', error);
              alert('圖片上傳失敗：' + error.message);
              return null;
            }
          } else {
            uploadedUrls.push(image.url);
          }
        }
        
        return uploadedUrls;
      }

      // 添加模態框外部點擊關閉功能
      function setupModalClickToClose() {
        const modals = document.querySelectorAll('.modal');
        
        modals.forEach(modal => {
          modal.addEventListener('click', function(e) {
            // 如果點擊的是模態框背景（而不是模態框內容），則關閉模態框
            if (e.target === modal) {
              modal.classList.remove('show');
            }
          });
        });

        // 添加 ESC 鍵關閉模態框功能
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            const openModal = document.querySelector('.modal.show');
            if (openModal) {
              openModal.classList.remove('show');
            }
          }
        });
      }

      // 頁面載入時設置模態框點擊關閉功能
      document.addEventListener('DOMContentLoaded', function() {
        setupModalClickToClose();
      });
    </script>

    <!-- 確認刪除對話框 -->
    <div id="deleteConfirmDialog" class="confirm-dialog">
      <div class="confirm-content">
        <h3>確認刪除</h3>
        <p id="deleteConfirmMessage">您確定要刪除這個檔案嗎？此操作無法撤銷。</p>
        <div class="confirm-actions">
          <button class="btn-cancel" onclick="hideDeleteConfirm()">取消</button>
          <button class="btn-delete" onclick="confirmDelete()">刪除</button>
        </div>
      </div>
    </div>
  </body>
</html>

    <script>
      // 全域變數
      // Token will be set by earlier initialization code
      
      // 檔案管理相關變數已在上方定義
      // 檢查身份驗證
      function checkAuth() {
        if (!accessToken) {
          // 在開發環境中自動登入
          autoDevLogin();
          return false;
        }
        return true;
      }

      // 自動開發登入
      async function autoDevLogin() {
        try {
          const response = await fetch('/api/auth/dev-login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              email: 'admin@test.com', 
              name: 'Admin User' 
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            accessToken = data.tokens.accessToken;
            localStorage.setItem('adminToken', accessToken);
            localStorage.setItem('accessToken', accessToken);
            
            // 初始化應用
            initApp();
          } else {
            console.error('Auto login failed');
            showLoginForm();
          }
        } catch (error) {
          console.error('Auto login error:', error);
          showLoginForm();
        }
      }

      // 顯示登入表單
      function showLoginForm() {
        const loginHtml = `
          <div style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 8px;
              width: 100%;
              max-width: 400px;
            ">
              <h2 style="margin-bottom: 1rem;">管理員登入</h2>
              <form id="loginForm">
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem;">使用者名稱</label>
                  <input type="text" id="username" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem;">密碼</label>
                  <input type="password" id="password" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <button type="submit" style="width: 100%; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">登入</button>
              </form>
              <div id="loginError" style="color: red; margin-top: 1rem; display: none;"></div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', loginHtml);
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          try {
            const response = await fetch('/api/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ username, password })
            });
            
            if (response.ok) {
              const data = await response.json();
              accessToken = data.token;
              localStorage.setItem('adminToken', accessToken);
              
              // 移除登入表單
              document.querySelector('[style*="position: fixed"]').remove();
              
              // 初始化應用
              initApp();
            } else {
              const error = await response.json();
              document.getElementById('loginError').textContent = error.message || '登入失敗';
              document.getElementById('loginError').style.display = 'block';
            }
          } catch (error) {
            document.getElementById('loginError').textContent = '連線錯誤，請稍後重試';
            document.getElementById('loginError').style.display = 'block';
          }
        });
      }

      // 初始化應用
      function initApp() {
        initTabNavigation();
        setupFileUpload();
        
        // 切換到檔案選項卡並載入檔案
        switchTab('files');
      }


      // 檔案類型圖標映射
      // 切換檔案視圖
      function switchFilesView(view) {
        currentView = view;
        
        // 更新按鈕狀態
        document.querySelectorAll('.view-toggle button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        // 切換視圖
        if (view === 'grid') {
          document.getElementById('filesGrid').style.display = 'grid';
          document.getElementById('filesList').style.display = 'none';
        } else {
          document.getElementById('filesGrid').style.display = 'none';
          document.getElementById('filesList').style.display = 'block';
        }
        
        renderFiles();
      }

      // 獲取檔案類型圖標
      function getFileTypeIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        return fileTypeIcons[extension] || fileTypeIcons.default;
      }

      // 格式化檔案大小
      // 格式化日期
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
      }

      // 渲染檔案
      function renderFiles() {
        console.log('renderFiles called, currentView:', currentView, 'currentFiles:', currentFiles.length);
        console.log('Current files data:', currentFiles);
        if (currentView === 'grid') {
          renderFilesGrid();
        } else {
          renderFilesList();
        }
      }

      // 渲染網格視圖
      function renderFilesGrid() {
        console.log('renderFilesGrid called');
        const container = document.getElementById('filesGrid');
        console.log('Grid container found:', !!container);
        console.log('Current files count:', currentFiles.length);
        console.log('Files data:', currentFiles);
        
        if (!container) {
          console.error('Grid container not found!');
          return;
        }
        
        if (currentFiles.length === 0) {
          console.log('No files to display');
          container.innerHTML = '';
          return;
        }
        
        console.log('Starting to generate HTML for files...');
        const html = currentFiles.map((file, index) => {
          console.log(`Processing file ${index}:`, file);
          const typeInfo = getFileTypeIcon(file.name);
          console.log(`File type info for ${file.name}:`, typeInfo);
          return `
            <div class="file-card" data-file-id="${file.id}">
              <div class="file-actions">
                <button class="action-btn download" onclick="downloadFile('${file.downloadSlug}')" title="下載">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                  </svg>
                </button>
                <button class="action-btn edit" onclick="editFile('${file.id}')" title="編輯">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                  </svg>
                </button>
                <button class="action-btn delete" onclick="showDeleteConfirm('${file.id}', '${file.name}')" title="刪除">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                </button>
              </div>
              <div class="file-icon ${typeInfo.class}">
                ${typeInfo.icon}
              </div>
              <div class="file-name" title="${file.name}">${file.name}</div>
              <div class="file-meta">${formatFileSize(file.sizeBytes)}</div>
              <div class="file-stats">
                <span>${file.downloads} 次下載</span>
                <span class="file-status ${file.isActive ? 'active' : 'inactive'}">
                  ${file.isActive ? '啟用' : '停用'}
                </span>
              </div>
            </div>
          `;
        }).join('');
        
        console.log('Generated HTML length:', html.length);
        console.log('Generated HTML preview:', html.substring(0, 200) + '...');
        container.innerHTML = html;
        console.log('HTML set to container, container children count:', container.children.length);
      }

      // 渲染列表視圖
      function renderFilesList() {
        const tbody = document.getElementById('filesTableBody');
        
        if (currentFiles.length === 0) {
          tbody.innerHTML = '';
          return;
        }
        
        const html = currentFiles.map(file => {
          const typeInfo = getFileTypeIcon(file.name);
          return `
            <tr data-file-id="${file.id}">
              <td>
                <div class="table-file-info">
                  <div class="table-file-icon ${typeInfo.class}">
                    ${typeInfo.icon}
                  </div>
                  <div class="table-file-details">
                    <div class="table-file-name">${file.name}</div>
                    <div class="table-file-meta">${file.originalName}</div>
                  </div>
                </div>
              </td>
              <td>${formatFileSize(file.sizeBytes)}</td>
              <td>${file.downloads}</td>
              <td>${formatDate(file.createdAt)}</td>
              <td>
                <div class="table-actions">
                  <button class="action-btn download" onclick="downloadFile('${file.downloadSlug}')" title="下載">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                    </svg>
                  </button>
                  <button class="action-btn edit" onclick="editFile('${file.id}')" title="編輯">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <button class="action-btn delete" onclick="showDeleteConfirm('${file.id}', '${file.name}')" title="刪除">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.innerHTML = html;
      }

      // 顯示刪除確認對話框
      function showDeleteConfirm(fileId, fileName) {
        deleteFileId = fileId;
        document.getElementById('deleteConfirmMessage').textContent = `您確定要刪除檔案「${fileName}」嗎？此操作無法撤銷。`;
        document.getElementById('deleteConfirmDialog').classList.add('show');
      }

      // 隱藏刪除確認對話框
      function hideDeleteConfirm() {
        deleteFileId = null;
        document.getElementById('deleteConfirmDialog').classList.remove('show');
      }

      // 確認刪除檔案
      async function confirmDelete() {
        if (!deleteFileId) return;
        
        try {
          const response = await fetch(`/api/files/${deleteFileId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            hideDeleteConfirm();
            loadFiles(); // 重新載入檔案列表
            alert('檔案刪除成功！');
          } else {
            const error = await response.json();
            alert(`刪除失敗：${error.message || '請稍後重試'}`);
          }
        } catch (error) {
          console.error('Delete file error:', error);
          alert('刪除失敗，請稍後重試');
        }
      }

      // 下載檔案
      function downloadFile(downloadSlug) {
        window.open(`/download/${downloadSlug}`, '_blank');
      }

      // 編輯檔案
      function editFile(fileId) {
        // 這裡可以實現檔案編輯功能，例如重新命名或更改描述
        const fileName = prompt('請輸入新的檔案名稱：');
        if (fileName && fileName.trim()) {
          updateFileName(fileId, fileName.trim());
        }
      }

      // 更新檔案名稱
      async function updateFileName(fileId, newName) {
        try {
          const response = await fetch(`/api/files/${fileId}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: newName })
          });
          
          if (response.ok) {
            loadFiles(); // 重新載入檔案列表
            alert('檔案名稱更新成功！');
          } else {
            const error = await response.json();
            alert(`更新失敗：${error.message || '請稍後重試'}`);
          }
        } catch (error) {
          console.error('Update file error:', error);
          alert('更新失敗，請稍後重試');
        }
      }

      // 載入檔案列表的更新版本
      async function loadFiles() {
        console.log('loadFiles called');
        const loadingEl = document.getElementById('filesLoading');
        const gridEl = document.getElementById('filesGrid');
        const listEl = document.getElementById('filesList');
        const emptyEl = document.getElementById('filesEmpty');
        
        console.log('DOM elements:', { loadingEl, gridEl, listEl, emptyEl });
        
        // 顯示載入狀態
        if (loadingEl) loadingEl.style.display = 'block';
        if (gridEl) gridEl.style.display = 'none';
        if (listEl) listEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'none';
        
        try {
          console.log('Making API request with token:', accessToken ? 'exists' : 'missing');
          const response = await fetch('/api/files', {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          console.log('API response status:', response.status);
          
          if (response.ok) {
            const data = await response.json();
            console.log('API response data:', data);
            currentFiles = data.files || [];
            console.log('currentFiles length:', currentFiles.length);
            
            // 隱藏載入狀態
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (currentFiles.length === 0) {
              console.log('No files, showing empty state');
              if (emptyEl) emptyEl.style.display = 'block';
            } else {
              console.log('Files found, currentView:', currentView);
              // 根據當前視圖顯示對應內容
              if (currentView === 'grid') {
                console.log('Showing grid view');
                if (gridEl) gridEl.style.display = 'grid';
              } else {
                console.log('Showing list view');
                if (listEl) listEl.style.display = 'block';
              }
              renderFiles();
            }
          } else {
            throw new Error('載入檔案失敗: ' + response.status);
          }
        } catch (error) {
          console.error('Load files error:', error);
          if (loadingEl) loadingEl.style.display = 'none';
          if (emptyEl) {
            emptyEl.style.display = 'block';
            emptyEl.innerHTML = `
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <h3>載入失敗</h3>
              <p>無法載入檔案列表：${error.message}</p>
              <button class="btn btn-primary" onclick="loadFiles()">重新載入</button>
            `;
          }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        init();
      });
