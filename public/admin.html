<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¾Œå°ç®¡ç† - Lead Magnet Platform</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f9fafb;
        color: #111827;
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Layout */
      .admin-layout {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 256px;
        background-color: #1f2937;
        color: white;
        padding: 1.5rem 0;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 0 1.5rem 2rem;
        border-bottom: 1px solid #374151;
      }

      .sidebar-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #f9fafb;
      }

      .sidebar-nav {
        margin-top: 2rem;
      }

      .nav-section {
        margin-bottom: 2rem;
      }

      .nav-section-title {
        padding: 0 1.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
      }

      .nav-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        color: #d1d5db;
        text-decoration: none;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }

      .nav-item:hover,
      .nav-item.active {
        background-color: #374151;
        color: #f9fafb;
        border-left-color: #f97316;
      }

      .nav-icon {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.75rem;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* Header */
      .header {
        background-color: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 2rem;
        display: flex;
        justify-content: between;
        align-items: center;
      }

      .header-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #111827;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: #f3f4f6;
        border-radius: 2rem;
        border: 1px solid #e5e7eb;
      }

      .user-avatar {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
      }

      /* Content Area */
      .content {
        padding: 2rem;
        flex: 1;
      }

      /* Cards */
      .card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
      }

      .card-content {
        padding: 1.5rem;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
      }

      .btn-primary {
        background-color: #f97316;
        color: white;
        font-weight: 600;
        transition: all 0.2s;
        transform: scale(1);
      }

      .btn-primary:hover {
        background-color: #ea580c;
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      }

      .btn-secondary {
        background-color: #6b7280;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #4b5563;
      }

      .btn-success {
        background-color: #059669;
        color: white;
      }

      .btn-danger {
        background-color: #dc2626;
        color: white;
      }

      /* File Upload Area */
      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #3b82f6;
        background-color: #f8fafc;
      }

      .upload-area.dragover {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }

      /* Table */
      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th,
      .table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      .table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
      }

      .table tbody tr:hover {
        background-color: #f9fafb;
      }

      /* Form */
      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
      }

      .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
      }

      .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .form-textarea {
        min-height: 4rem;
        resize: vertical;
      }

      /* Status badges */
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .badge-success {
        background-color: #dcfce7;
        color: #059669;
      }

      .badge-warning {
        background-color: #fef3c7;
        color: #d97706;
      }

      .badge-danger {
        background-color: #fee2e2;
        color: #dc2626;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .modal-title {
        font-size: 1.125rem;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
      }

      /* Tabs */
      .tabs {
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
      }

      .tab-list {
        display: flex;
        gap: 0;
      }

      .tab {
        padding: 0.75rem 1rem;
        border: none;
        background: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        color: #6b7280;
        font-weight: 500;
      }

      .tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Loading */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .spinner {
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        width: 2rem;
        height: 2rem;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Utilities */
      .hidden {
        display: none;
      }
      .text-center {
        text-align: center;
      }
      .text-right {
        text-align: right;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .flex {
        display: flex;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .gap-2 {
        gap: 0.5rem;
      }
      
      /* Image Manager Styles */
      .image-manager {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        background: #f9fafb;
        margin-bottom: 1rem;
      }
      
      .image-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .image-item {
        position: relative;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        overflow: hidden;
        background: white;
      }
      
      .image-item img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        display: block;
      }
      
      .image-item-controls {
        position: absolute;
        top: 4px;
        right: 4px;
        display: flex;
        gap: 4px;
      }
      
      .image-btn {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
      }
      
      .image-btn:hover {
        background: rgba(0, 0, 0, 0.9);
      }
      
      .image-add-options {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
      }
      
      .image-upload-area, .image-url-area {
        padding: 1rem;
        border: 1px dashed #d1d5db;
        border-radius: 8px;
        background: white;
      }
      
      .upload-preview {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.5rem;
      }
      
      .upload-preview img {
        width: 100%;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }
      
      .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
      }
      
      .carousel-container {
        position: relative;
        margin-bottom: 1.5rem;
      }
      
      .carousel-slides {
        display: flex;
        overflow: hidden;
        border-radius: 12px;
      }
      
      .carousel-slide {
        min-width: 100%;
        transition: transform 0.3s ease;
      }
      
      .carousel-slide img {
        width: 100%;
        height: 300px;
        object-fit: cover;
      }
      
      .carousel-controls {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
      }
      
      .carousel-prev {
        left: 10px;
      }
      
      .carousel-next {
        right: 10px;
      }
      
      .carousel-indicators {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 12px;
      }
      
      .carousel-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #d1d5db;
        cursor: pointer;
        transition: background 0.3s;
      }
      
      .carousel-indicator.active {
        background: #16a34a;
      }

      /* æª”æ¡ˆç®¡ç†è¦–åœ–æ¨£å¼ */
      .files-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 0 5px;
      }

      .view-toggle {
        display: flex;
        background: #f1f3f4;
        border-radius: 8px;
        padding: 4px;
        gap: 4px;
      }

      .view-toggle button {
        background: transparent;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        font-size: 14px;
      }

      .view-toggle button.active {
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      .view-toggle button:hover:not(.active) {
        background: rgba(255,255,255,0.7);
      }

      /* ç¶²æ ¼è¦–åœ– */
      .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        padding: 10px 0;
      }

      .file-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .file-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
        border-color: #3b82f6;
      }

      .file-card.selected {
        border-color: #3b82f6;
        background: #f8faff;
      }

      .file-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 12px;
        background: #f3f4f6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #6b7280;
      }

      .file-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #1f2937;
      }

      .file-meta {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .file-stats {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #6b7280;
      }

      .file-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .file-card:hover .file-actions {
        opacity: 1;
      }

      .action-btn {
        background: rgba(255,255,255,0.9);
        border: none;
        border-radius: 6px;
        width: 28px;
        height: 28px;
        margin-left: 4px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 14px;
      }

      .action-btn:hover {
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .action-btn.delete {
        color: #dc2626;
      }

      .action-btn.edit {
        color: #3b82f6;
      }

      .action-btn.download {
        color: #059669;
      }

      /* åˆ—è¡¨è¦–åœ– */
      .files-list {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }

      .files-table {
        width: 100%;
        border-collapse: collapse;
      }

      .files-table thead th {
        background: #f9fafb;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #e5e7eb;
      }

      .files-table tbody tr {
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s;
      }

      .files-table tbody tr:hover {
        background: #f8faff;
      }

      .files-table tbody tr.selected {
        background: #eff6ff;
      }

      .files-table tbody td {
        padding: 12px 16px;
        vertical-align: middle;
      }

      .table-file-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .table-file-icon {
        width: 32px;
        height: 32px;
        background: #f3f4f6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #6b7280;
      }

      .table-file-details {
        flex: 1;
      }

      .table-file-name {
        font-weight: 500;
        font-size: 14px;
        color: #1f2937;
        margin-bottom: 2px;
      }

      .table-file-meta {
        font-size: 12px;
        color: #6b7280;
      }

      .table-actions {
        display: flex;
        gap: 8px;
      }

      /* ç©ºç‹€æ…‹ */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
      }

      .empty-state svg {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
      }

      .empty-state p {
        font-size: 14px;
        margin-bottom: 20px;
      }

      /* æª”æ¡ˆé¡å‹åœ–æ¨™ */
      .file-type-pdf { background: #fee2e2; color: #dc2626; }
      .file-type-doc { background: #dbeafe; color: #2563eb; }
      .file-type-xlsx { background: #dcfce7; color: #16a34a; }
      .file-type-image { background: #fef3c7; color: #d97706; }
      .file-type-other { background: #f3f4f6; color: #6b7280; }

      /* è¼‰å…¥å‹•ç•« */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* ç¢ºèªå°è©±æ¡† */
      .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
      }

      .confirm-dialog.show {
        opacity: 1;
        visibility: visible;
      }

      .confirm-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        transform: scale(0.9);
        transition: transform 0.2s;
      }

      .confirm-dialog.show .confirm-content {
        transform: scale(1);
      }

      .confirm-content h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1f2937;
      }

      .confirm-content p {
        color: #6b7280;
        margin-bottom: 20px;
      }

      .confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .confirm-actions button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .confirm-actions .btn-cancel {
        background: #f3f4f6;
        color: #374151;
      }

      .confirm-actions .btn-cancel:hover {
        background: #e5e7eb;
      }

      .confirm-actions .btn-delete {
        background: #dc2626;
        color: white;
      }

      .confirm-actions .btn-delete:hover {
        background: #b91c1c;
      }

      /* Grid utilities */
      .grid {
        display: grid;
      }
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .gap-4 {
        gap: 1rem;
      }

      /* Feature items */
      .feature-item h4 {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
      }
      .feature-list {
        list-style: none;
        padding: 0;
      }
      .feature-list li {
        padding: 0.25rem 0;
        color: #6b7280;
        font-size: 0.875rem;
      }
      .feature-list li:before {
        content: "âœ“ ";
        color: #10b981;
        font-weight: bold;
        margin-right: 0.5rem;
      }

      /* Card header with button */
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="admin-layout">
      <!-- Sidebar -->
      <nav class="sidebar">
        <div class="sidebar-header">
          <div class="admin-logo-container" style="display: flex; align-items: center; padding: 0 1.5rem 2rem;">
            <img src="/logo.png" alt="Upper Logo" style="height: 2rem; width: auto; margin-right: 0.75rem;">
            <h1 style="font-size: 1.5rem; font-weight: 700; color: #f9fafb; letter-spacing: -0.025em;">Upper</h1>
          </div>
        </div>

        <div class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-section-title">ç®¡ç†</div>
            <a href="#dashboard" class="nav-item active" data-tab="dashboard">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"
                />
              </svg>
              å„€è¡¨æ¿
            </a>
            <a href="#files" class="nav-item" data-tab="files">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              æª”æ¡ˆç®¡ç†
            </a>
            <a href="#pages" class="nav-item" data-tab="pages">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                />
              </svg>
              ä¸‹è¼‰é é¢
            </a>
            <a href="#leads" class="nav-item" data-tab="leads">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                />
              </svg>
              æ½›åœ¨å®¢æˆ¶
            </a>
            <a href="#file-creator" class="nav-item" data-tab="file-creator">
              <svg
                class="nav-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                />
              </svg>
              æª”æ¡ˆè£½ä½œ
            </a>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <header class="header">
          <h2 id="pageTitle" class="header-title">å„€è¡¨æ¿</h2>
          <div class="user-menu">
            <div class="user-info">
              <img id="userAvatar" class="user-avatar" src="" alt="ç”¨æˆ¶é ­åƒ" />
              <span id="userName">è¼‰å…¥ä¸­...</span>
            </div>
            <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
          </div>
        </header>

        <!-- Content -->
        <main class="content">
          <!-- Dashboard Tab -->
          <div id="dashboard-tab" class="tab-content active">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">å¿«é€Ÿçµ±è¨ˆ</h3>
              </div>
              <div class="card-content">
                <div class="flex gap-2">
                  <div
                    class="card"
                    style="flex: 1; margin: 0; margin-right: 1rem"
                  >
                    <div class="card-content">
                      <div class="text-center">
                        <div
                          id="totalFiles"
                          style="
                            font-size: 2rem;
                            font-weight: bold;
                            color: #3b82f6;
                          "
                        >
                          0
                        </div>
                        <div style="color: #6b7280">æª”æ¡ˆç¸½æ•¸</div>
                      </div>
                    </div>
                  </div>
                  <div
                    class="card"
                    style="flex: 1; margin: 0; margin-right: 1rem"
                  >
                    <div class="card-content">
                      <div class="text-center">
                        <div
                          id="totalPages"
                          style="
                            font-size: 2rem;
                            font-weight: bold;
                            color: #059669;
                          "
                        >
                          0
                        </div>
                        <div style="color: #6b7280">ä¸‹è¼‰é æ•¸</div>
                      </div>
                    </div>
                  </div>
                  <div
                    class="card"
                    style="flex: 1; margin: 0; margin-right: 1rem"
                  >
                    <div class="card-content">
                      <div class="text-center">
                        <div
                          id="totalDownloads"
                          style="
                            font-size: 2rem;
                            font-weight: bold;
                            color: #dc2626;
                          "
                        >
                          0
                        </div>
                        <div style="color: #6b7280">ç¸½ä¸‹è¼‰æ¬¡æ•¸</div>
                      </div>
                    </div>
                  </div>
                  <div class="card" style="flex: 1; margin: 0">
                    <div class="card-content">
                      <div class="text-center">
                        <div
                          id="totalLeads"
                          style="
                            font-size: 2rem;
                            font-weight: bold;
                            color: #f59e0b;
                          "
                        >
                          0
                        </div>
                        <div style="color: #6b7280">æ”¶é›†åå–®</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title">å¿«é€Ÿæ“ä½œ</h3>
              </div>
              <div class="card-content">
                <div class="flex gap-2">
                  <button class="btn btn-primary" onclick="switchTab('files')">
                    <svg
                      style="width: 1rem; height: 1rem; margin-right: 0.5rem"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                      />
                    </svg>
                    ä¸Šå‚³æª”æ¡ˆ
                  </button>
                  <button class="btn btn-success" onclick="switchTab('pages')">
                    <svg
                      style="width: 1rem; height: 1rem; margin-right: 0.5rem"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                      />
                    </svg>
                    æ–°å¢ä¸‹è¼‰é 
                  </button>
                  <button
                    class="btn btn-secondary"
                    onclick="switchTab('analytics')"
                  >
                    <svg
                      style="width: 1rem; height: 1rem; margin-right: 0.5rem"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                      />
                    </svg>
                    æŸ¥çœ‹æ•¸æ“š
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Files Tab -->
          <div id="files-tab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æª”æ¡ˆä¸Šå‚³</h3>
              </div>
              <div class="card-content">
                <div id="uploadArea" class="upload-area">
                  <svg
                    style="
                      width: 3rem;
                      height: 3rem;
                      margin: 0 auto 1rem;
                      color: #6b7280;
                    "
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                    />
                  </svg>
                  <p style="font-weight: 500; margin-bottom: 0.5rem">
                    é»æ“Šæˆ–æ‹–æ‹½æª”æ¡ˆåˆ°é€™è£¡ä¸Šå‚³
                  </p>
                  <p style="color: #6b7280; font-size: 0.875rem">
                    æ”¯æ´ PDF, DOC, DOCX, TXT, JPG, PNG, ZIP ç­‰æ ¼å¼
                  </p>
                </div>
                <div id="uploadProgress" class="hidden mt-4">
                  <div
                    style="
                      background: #e5e7eb;
                      border-radius: 0.5rem;
                      height: 0.5rem;
                    "
                  >
                    <div
                      id="progressBar"
                      style="
                        background: #3b82f6;
                        border-radius: 0.5rem;
                        height: 100%;
                        width: 0%;
                        transition: width 0.3s;
                      "
                    ></div>
                  </div>
                  <p
                    id="uploadStatus"
                    class="mt-2 text-center"
                    style="color: #6b7280; font-size: 0.875rem"
                  ></p>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="files-header">
                <h3 class="card-title">æˆ‘çš„æª”æ¡ˆ</h3>
                <div class="files-controls">
                  <div class="view-toggle">
                    <button class="active" onclick="switchFilesView('grid')" data-view="grid">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z"/>
                      </svg>
                      ç¶²æ ¼
                    </button>
                    <button onclick="switchFilesView('list')" data-view="list">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                      </svg>
                      åˆ—è¡¨
                    </button>
                  </div>
                  <div class="files-actions">
                    <input type="file" id="fileInput" style="display: none;" multiple>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                        <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                      </svg>
                      ä¸Šå‚³æª”æ¡ˆ
                    </button>
                    <button class="btn btn-primary" onclick="loadFiles()">
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                        <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                      </svg>
                      é‡æ–°æ•´ç†
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="card-content">
                <div id="filesLoading" class="loading">
                  <div class="spinner"></div>
                </div>

                <!-- ç¶²æ ¼è¦–åœ– -->
                <div id="filesGrid" class="files-grid" style="display: none;">
                  <!-- æª”æ¡ˆå¡ç‰‡æœƒå‹•æ…‹è¼‰å…¥ -->
                </div>

                <!-- åˆ—è¡¨è¦–åœ– -->
                <div id="filesList" class="files-list" style="display: none;">
                  <table class="files-table">
                    <thead>
                      <tr>
                        <th style="width: 40%;">æª”æ¡ˆ</th>
                        <th style="width: 15%;">å¤§å°</th>
                        <th style="width: 15%;">ä¸‹è¼‰æ¬¡æ•¸</th>
                        <th style="width: 15%;">ä¸Šå‚³æ™‚é–“</th>
                        <th style="width: 15%;">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="filesTableBody"></tbody>
                  </table>
                </div>

                <!-- ç©ºç‹€æ…‹ -->
                <div id="filesEmpty" class="empty-state" style="display: none;">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <h3>é‚„æ²’æœ‰æª”æ¡ˆ</h3>
                  <p>ä¸Šå‚³æ‚¨çš„ç¬¬ä¸€å€‹æª”æ¡ˆé–‹å§‹ä½¿ç”¨</p>
                  <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                      <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    ä¸Šå‚³æª”æ¡ˆ
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pages Tab -->
          <div id="pages-tab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ä¸‹è¼‰é é¢ç®¡ç†</h3>
                <button class="btn btn-primary" onclick="showCreatePageModal()">
                  æ–°å¢é é¢
                </button>
              </div>
              <div class="card-content">
                <div id="pagesLoading" class="loading">
                  <div class="spinner"></div>
                </div>
                <div id="pagesList" class="hidden">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>é é¢æ¨™é¡Œ</th>
                        <th>é—œè¯æª”æ¡ˆ</th>
                        <th>ç€è¦½æ¬¡æ•¸</th>
                        <th>ä¸‹è¼‰æ¬¡æ•¸</th>
                        <th>å»ºç«‹æ™‚é–“</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="pagesTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Leads Tab -->
          <div id="leads-tab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æ½›åœ¨å®¢æˆ¶åå–®</h3>
                <button class="btn btn-secondary" onclick="exportLeads()">
                  åŒ¯å‡º CSV
                </button>
              </div>
              <div class="card-content">
                <div id="leadsLoading" class="loading">
                  <div class="spinner"></div>
                </div>
                <div id="leadsList" class="hidden">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>é›»å­éƒµä»¶</th>
                        <th>å§“å</th>
                        <th>ä¾†æºé é¢</th>
                        <th>ä¸‹è¼‰æª”æ¡ˆ</th>
                        <th>æäº¤æ™‚é–“</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="leadsTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- File Creator Tab -->
          <div id="file-creator-tab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ç·šä¸Šæª”æ¡ˆè£½ä½œ</h3>
                <button class="btn btn-primary" onclick="window.open('/file-creator.html', '_blank')">
                  é–‹å•Ÿæª”æ¡ˆè£½ä½œå·¥å…·
                </button>
              </div>
              <div class="card-content">
                <p style="color: #6b7280; margin-bottom: 1rem;">
                  ç›´æ¥åœ¨ç€è¦½å™¨ä¸­å‰µå»ºå„ç¨®æ ¼å¼çš„æª”æ¡ˆï¼Œæ”¯æ´ TXTã€JSONã€CSVã€HTMLã€XMLã€Markdownã€PDF ç­‰æ ¼å¼ã€‚
                </p>
                <div class="grid grid-cols-2 gap-4">
                  <div class="feature-item">
                    <h4>æ”¯æ´æ ¼å¼</h4>
                    <ul class="feature-list">
                      <li>ç´”æ–‡å­— (TXT)</li>
                      <li>çµæ§‹åŒ–æ•¸æ“š (JSON, CSV, XML)</li>
                      <li>ç¶²é æ–‡ä»¶ (HTML)</li>
                      <li>æ–‡æª”æ ¼å¼ (Markdown, PDF)</li>
                    </ul>
                  </div>
                  <div class="feature-item">
                    <h4>å¿«é€Ÿæ¨¡æ¿</h4>
                    <ul class="feature-list">
                      <li>é è¨­æ¨¡æ¿å¿«é€Ÿé–‹å§‹</li>
                      <li>å³æ™‚é è¦½å’Œç·¨è¼¯</li>
                      <li>è‡ªå‹•ç”¢ç”Ÿåˆ†äº«é é¢</li>
                      <li>æª”æ¡ˆçµ±è¨ˆè¿½è¹¤</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Create Page Modal -->
    <div id="createPageModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">æ–°å¢ä¸‹è¼‰é é¢</h3>
          <button class="modal-close" onclick="hideCreatePageModal()">
            &times;
          </button>
        </div>
        <form id="createPageForm">
          <div class="form-group">
            <label class="form-label">é é¢æ¨™é¡Œ</label>
            <input
              type="text"
              class="form-input"
              name="title"
              required
              placeholder="è¼¸å…¥é é¢æ¨™é¡Œ"
            />
          </div>
          <div class="form-group">
            <label class="form-label">é é¢æè¿°</label>
            <textarea
              class="form-input form-textarea"
              name="description"
              placeholder="è¼¸å…¥é é¢æè¿°"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">é—œè¯æª”æ¡ˆ</label>
            <select class="form-input" name="fileId" required>
              <option value="">è«‹é¸æ“‡æª”æ¡ˆ</option>
            </select>
          </div>
          
          <!-- åœ–ç‰‡ç®¡ç†å€åŸŸ -->
          <div class="form-group">
            <label class="form-label">é é¢åœ–ç‰‡</label>
            <div id="createPageImages" class="image-manager">
              <!-- åœ–ç‰‡åˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
            </div>
            
            <!-- æ·»åŠ åœ–ç‰‡é¸é … -->
            <div class="image-add-options">
              <div class="flex gap-2 mb-4">
                <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUploadOption('create')">
                  ğŸ“ ä¸Šå‚³åœ–ç‰‡
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUrlOption('create')">
                  ğŸ”— åœ–ç‰‡ç¶²å€
                </button>
              </div>
              
              <!-- ä¸Šå‚³åœ–ç‰‡å€åŸŸ -->
              <div id="createImageUploadArea" class="image-upload-area hidden">
                <input type="file" id="createImageUpload" multiple accept="image/*" class="form-input">
                <div class="upload-preview" id="createUploadPreview"></div>
              </div>
              
              <!-- åœ–ç‰‡ç¶²å€å€åŸŸ -->
              <div id="createImageUrlArea" class="image-url-area hidden">
                <div class="flex gap-2">
                  <input type="url" id="createImageUrl" placeholder="è¼¸å…¥åœ–ç‰‡ç¶²å€" class="form-input">
                  <button type="button" class="btn btn-primary btn-sm" onclick="addImageUrl('create')">æ·»åŠ </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">æ”¶é›†é›»å­éƒµä»¶</label>
            <select class="form-input" name="requireEmail">
              <option value="true">æ˜¯ - éœ€è¦è¼¸å…¥é›»å­éƒµä»¶æ‰èƒ½ä¸‹è¼‰</option>
              <option value="false">å¦ - ç›´æ¥ä¸‹è¼‰</option>
            </select>
          </div>
          <div class="flex gap-2 justify-between">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="hideCreatePageModal()"
            >
              å–æ¶ˆ
            </button>
            <button type="submit" class="btn btn-primary">å»ºç«‹é é¢</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Page Modal -->
    <div id="editPageModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">ç·¨è¼¯ä¸‹è¼‰é é¢</h3>
          <button class="modal-close" onclick="hideEditPageModal()">
            &times;
          </button>
        </div>
        <form id="editPageForm">
          <div class="form-group">
            <label class="form-label">é é¢æ¨™é¡Œ</label>
            <input
              type="text"
              class="form-input"
              id="editPageTitle"
              name="title"
              required
              placeholder="è¼¸å…¥é é¢æ¨™é¡Œ"
            />
          </div>
          <div class="form-group">
            <label class="form-label">é é¢æè¿°</label>
            <textarea
              class="form-input form-textarea"
              id="editPageDescription"
              name="description"
              placeholder="è¼¸å…¥é é¢æè¿°"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">é—œè¯æª”æ¡ˆ</label>
            <select class="form-input" id="editPageFileId" name="fileId">
              <option value="">é¸æ“‡æª”æ¡ˆ (å¯é¸)</option>
            </select>
          </div>
          
          <!-- åœ–ç‰‡ç®¡ç†å€åŸŸ -->
          <div class="form-group">
            <label class="form-label">é é¢åœ–ç‰‡</label>
            <div id="editPageImages" class="image-manager">
              <!-- åœ–ç‰‡åˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
            </div>
            
            <!-- æ·»åŠ åœ–ç‰‡é¸é … -->
            <div class="image-add-options">
              <div class="flex gap-2 mb-4">
                <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUploadOption('edit')">
                  ğŸ“ ä¸Šå‚³åœ–ç‰‡
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="showImageUrlOption('edit')">
                  ğŸ”— åœ–ç‰‡ç¶²å€
                </button>
              </div>
              
              <!-- ä¸Šå‚³åœ–ç‰‡å€åŸŸ -->
              <div id="editImageUploadArea" class="image-upload-area hidden">
                <input type="file" id="editImageUpload" multiple accept="image/*" class="form-input">
                <div class="upload-preview" id="editUploadPreview"></div>
              </div>
              
              <!-- åœ–ç‰‡ç¶²å€å€åŸŸ -->
              <div id="editImageUrlArea" class="image-url-area hidden">
                <div class="flex gap-2">
                  <input type="url" id="editImageUrl" placeholder="è¼¸å…¥åœ–ç‰‡ç¶²å€" class="form-input">
                  <button type="button" class="btn btn-primary btn-sm" onclick="addImageUrl('edit')">æ·»åŠ </button>
                </div>
              </div>
            </div>
          </div>
          <div class="flex gap-2 justify-between">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="hideEditPageModal()"
            >
              å–æ¶ˆ
            </button>
            <button type="submit" class="btn btn-primary">æ›´æ–°é é¢</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Global variables
      let currentUser = null;
      let currentFiles = [];
      let currentView = 'grid';
      let accessToken = localStorage.getItem('accessToken') || localStorage.getItem('authToken') || localStorage.getItem('adminToken');
      let refreshToken = null;
      let deleteFileId = null;

      // æª”æ¡ˆé¡å‹åœ–æ¨™é…ç½®
      const fileTypeIcons = {
        'pdf': { icon: 'ğŸ“„', class: 'file-type-pdf' },
        'doc': { icon: 'ğŸ“', class: 'file-type-doc' },
        'docx': { icon: 'ğŸ“', class: 'file-type-doc' },
        'xls': { icon: 'ğŸ“Š', class: 'file-type-xlsx' },
        'xlsx': { icon: 'ğŸ“Š', class: 'file-type-xlsx' },
        'ppt': { icon: 'ğŸ“½ï¸', class: 'file-type-other' },
        'pptx': { icon: 'ğŸ“½ï¸', class: 'file-type-other' },
        'txt': { icon: 'ğŸ“„', class: 'file-type-other' },
        'jpg': { icon: 'ğŸ–¼ï¸', class: 'file-type-image' },
        'jpeg': { icon: 'ğŸ–¼ï¸', class: 'file-type-image' },
        'png': { icon: 'ğŸ–¼ï¸', class: 'file-type-image' },
        'gif': { icon: 'ğŸ–¼ï¸', class: 'file-type-image' },
        'zip': { icon: 'ğŸ—œï¸', class: 'file-type-other' },
        'rar': { icon: 'ğŸ—œï¸', class: 'file-type-other' },
        'default': { icon: 'ğŸ“„', class: 'file-type-other' }
      };

      // è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
      async function loadFiles() {
        console.log('loadFiles called');
        const loadingEl = document.getElementById('filesLoading');
        const gridEl = document.getElementById('filesGrid');
        const listEl = document.getElementById('filesList');
        const emptyEl = document.getElementById('filesEmpty');
        
        console.log('DOM elements:', { loadingEl, gridEl, listEl, emptyEl });
        
        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        if (!accessToken) {
          console.log('No access token found');
          showLoginRequired();
          return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        if (loadingEl) loadingEl.style.display = 'block';
        if (gridEl) gridEl.style.display = 'none';
        if (listEl) listEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'none';
        
        try {
          console.log('Making API request with token:', accessToken ? 'exists' : 'missing');
          const response = await fetch('/api/files', {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          console.log('API response status:', response.status);
          
          if (response.status === 401) {
            console.log('Authentication failed - token expired or invalid');
            // æ¸…é™¤ç„¡æ•ˆçš„ token
            clearAuthData();
            showLoginRequired();
            return;
          }
          
          if (response.ok) {
            const data = await response.json();
            console.log('API response data:', data);
            currentFiles = data.files || [];
            console.log('currentFiles length:', currentFiles.length);
            
            // éš±è—è¼‰å…¥ç‹€æ…‹
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (currentFiles.length === 0) {
              console.log('No files, showing empty state');
              if (emptyEl) emptyEl.style.display = 'block';
            } else {
              console.log('Files found, currentView:', currentView);
              // æ ¹æ“šç•¶å‰è¦–åœ–é¡¯ç¤ºå°æ‡‰å…§å®¹
              if (currentView === 'grid') {
                console.log('Showing grid view');
                if (gridEl) gridEl.style.display = 'grid';
              } else {
                console.log('Showing list view');
                if (listEl) listEl.style.display = 'block';
              }
              renderFiles();
            }
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          console.error('Load files error:', error);
          if (loadingEl) loadingEl.style.display = 'none';
          
          // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
          if (emptyEl) {
            emptyEl.style.display = 'block';
            emptyEl.innerHTML = `
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <h3>è¼‰å…¥å¤±æ•—</h3>
              <p>ç„¡æ³•è¼‰å…¥æª”æ¡ˆåˆ—è¡¨ï¼š${error.message}</p>
              <button class="btn btn-primary" onclick="loadFiles()">é‡æ–°è¼‰å…¥</button>
            `;
          }
        }
      }

      // é¡¯ç¤ºéœ€è¦ç™»å…¥çš„æç¤º
      function showLoginRequired() {
        const loadingEl = document.getElementById('filesLoading');
        const gridEl = document.getElementById('filesGrid');
        const listEl = document.getElementById('filesList');
        const emptyEl = document.getElementById('filesEmpty');
        
        // éš±è—å…¶ä»–å…ƒç´ 
        if (loadingEl) loadingEl.style.display = 'none';
        if (gridEl) gridEl.style.display = 'none';
        if (listEl) listEl.style.display = 'none';
        
        // é¡¯ç¤ºç™»å…¥æç¤º
        if (emptyEl) {
          emptyEl.style.display = 'block';
          emptyEl.innerHTML = `
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
            </svg>
            <h3>éœ€è¦ç™»å…¥</h3>
            <p>è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹å’Œç®¡ç†æª”æ¡ˆ</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
              <button class="btn btn-primary" onclick="window.open('/quick-login.html', '_blank')">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                  <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                </svg>
                å¿«é€Ÿç™»å…¥
              </button>
              <button class="btn btn-secondary" onclick="loadFiles()">é‡æ–°æª¢æŸ¥</button>
            </div>
          `;
        }
        
        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹é¡¯ç¤º
        updateUserStatus(false);
      }

      // æ¸…é™¤èªè­‰æ•¸æ“š
      function clearAuthData() {
        accessToken = null;
        refreshToken = null;
        currentUser = null;
        localStorage.removeItem('accessToken');
        localStorage.removeItem('authToken');
        localStorage.removeItem('adminToken');
        localStorage.removeItem('refreshToken');
      }

      // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹é¡¯ç¤º
      function updateUserStatus(isLoggedIn, user = null) {
        const userInfo = document.querySelector('.user-info');
        if (!userInfo) return;
        
        if (isLoggedIn && user) {
          userInfo.style.display = 'flex';
          userInfo.innerHTML = `
            <img src="${user.avatar}" alt="${user.name}" class="user-avatar">
            <div class="user-details">
              <div class="user-name">${user.name}</div>
              <div class="user-email">${user.email}</div>
            </div>
            <div class="user-menu">
              <button onclick="logout()" class="btn btn-secondary">ç™»å‡º</button>
            </div>
          `;
        } else {
          userInfo.style.display = 'flex';
          userInfo.innerHTML = `
            <div class="user-details">
              <div class="user-name">æœªç™»å…¥</div>
              <div class="user-email">è«‹ç™»å…¥ä»¥ç®¡ç†æª”æ¡ˆ</div>
            </div>
            <div class="user-menu">
              <button onclick="window.open('/quick-login.html', '_blank')" class="btn btn-primary">ç™»å…¥</button>
            </div>
          `;
        }
      }

      // ç™»å‡ºå‡½æ•¸
      function logout() {
        clearAuthData();
        showLoginRequired();
        updateUserStatus(false);
      }

      // åˆ‡æ›æª”æ¡ˆè¦–åœ–
      function switchFilesView(view) {
        currentView = view;
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.view-toggle button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        // åˆ‡æ›è¦–åœ–
        if (view === 'grid') {
          document.getElementById('filesGrid').style.display = 'grid';
          document.getElementById('filesList').style.display = 'none';
        } else {
          document.getElementById('filesGrid').style.display = 'none';
          document.getElementById('filesList').style.display = 'block';
        }
        
        renderFiles();
      }

      // å·¥å…·å‡½æ•¸

      // ç²å–æª”æ¡ˆé¡å‹åœ–æ¨™
      function getFileTypeIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        return fileTypeIcons[extension] || fileTypeIcons.default;
      }

      // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // æ ¼å¼åŒ–æ—¥æœŸ
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
      }

      // æ¸²æŸ“å‡½æ•¸
      function renderFiles() {
        console.log('renderFiles called, currentView:', currentView, 'currentFiles:', currentFiles.length);
        console.log('Current files data:', currentFiles);
        if (currentView === 'grid') {
          renderFilesGrid();
        } else {
          renderFilesList();
        }
      }

      // æ¸²æŸ“ç¶²æ ¼è¦–åœ–
      function renderFilesGrid() {
        console.log('renderFilesGrid called');
        const container = document.getElementById('filesGrid');
        console.log('Grid container found:', !!container);
        console.log('Current files count:', currentFiles.length);
        console.log('Files data:', currentFiles);
        
        if (!container) {
          console.error('Grid container not found!');
          return;
        }
        
        if (currentFiles.length === 0) {
          console.log('No files to display');
          container.innerHTML = '';
          return;
        }
        
        console.log('Starting to generate HTML for files...');
        const html = currentFiles.map((file, index) => {
          console.log(`Processing file ${index}:`, file);
          const typeInfo = getFileTypeIcon(file.name);
          console.log(`File type info for ${file.name}:`, typeInfo);
          return `
            <div class="file-card" data-file-id="${file.id}">
              <div class="file-actions">
                <button class="action-btn download" onclick="downloadFile('${file.downloadSlug}')" title="ä¸‹è¼‰">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                  </svg>
                </button>
                <button class="action-btn edit" onclick="editFile('${file.id}')" title="ç·¨è¼¯">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                  </svg>
                </button>
                <button class="action-btn delete" onclick="showDeleteConfirm('${file.id}', '${file.name}')" title="åˆªé™¤">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                </button>
              </div>
              <div class="file-icon ${typeInfo.class}">
                ${typeInfo.icon}
              </div>
              <div class="file-name" title="${file.name}">${file.name}</div>
              <div class="file-meta">${formatFileSize(file.sizeBytes)}</div>
              <div class="file-stats">
                <span>${file.downloads} æ¬¡ä¸‹è¼‰</span>
                <span class="file-status ${file.isActive ? 'active' : 'inactive'}">
                  ${file.isActive ? 'å•Ÿç”¨' : 'åœç”¨'}
                </span>
              </div>
            </div>
          `;
        }).join('');
        
        console.log('Generated HTML length:', html.length);
        console.log('Generated HTML preview:', html.substring(0, 200) + '...');
        container.innerHTML = html;
        console.log('HTML set to container, container children count:', container.children.length);
      }

      // æ¸²æŸ“åˆ—è¡¨è¦–åœ–
      function renderFilesList() {
        const tbody = document.getElementById('filesTableBody');
        
        if (currentFiles.length === 0) {
          tbody.innerHTML = '';
          return;
        }
        
        const html = currentFiles.map(file => {
          const typeInfo = getFileTypeIcon(file.name);
          return `
            <tr data-file-id="${file.id}">
              <td>
                <div class="table-file-info">
                  <div class="table-file-icon ${typeInfo.class}">
                    ${typeInfo.icon}
                  </div>
                  <div class="table-file-details">
                    <div class="table-file-name">${file.name}</div>
                    <div class="table-file-meta">${file.originalName}</div>
                  </div>
                </div>
              </td>
              <td>${formatFileSize(file.sizeBytes)}</td>
              <td>${file.downloads}</td>
              <td>${formatDate(file.createdAt)}</td>
              <td>
                <div class="table-actions">
                  <button class="action-btn download" onclick="downloadFile('${file.downloadSlug}')" title="ä¸‹è¼‰">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                    </svg>
                  </button>
                  <button class="action-btn edit" onclick="editFile('${file.id}')" title="ç·¨è¼¯">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <button class="action-btn delete" onclick="showDeleteConfirm('${file.id}', '${file.name}')" title="åˆªé™¤">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.innerHTML = html;
      }

      // é¸é …å¡å°èˆªåŠŸèƒ½
      function initTabNavigation() {
        // ç²å–æ‰€æœ‰å°èˆªé …ç›®
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        navItems.forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            
            const tabId = item.getAttribute('data-tab');
            
            // ç§»é™¤æ‰€æœ‰æ´»å‹•ç‹€æ…‹
            navItems.forEach(nav => nav.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // æ·»åŠ ç•¶å‰æ´»å‹•ç‹€æ…‹
            item.classList.add('active');
            const targetContent = document.getElementById(tabId + '-tab');
            if (targetContent) {
              targetContent.classList.add('active');
            }
            
            // å¦‚æœåˆ‡æ›åˆ°æª”æ¡ˆé¸é …å¡ï¼Œè¼‰å…¥æª”æ¡ˆåˆ—è¡¨
            if (tabId === 'files') {
              loadFiles();
            }
          });
        });
      }
      let pages = [];
      let leads = [];

      // Handle OAuth callback
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get("token")) {
        accessToken = urlParams.get("token");
        const refreshToken = urlParams.get("refreshToken");

        localStorage.setItem("accessToken", accessToken);
        if (refreshToken) {
          localStorage.setItem("refreshToken", refreshToken);
        }

        // Clean URL
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );
      }

      // Initialize
      async function init() {
        try {
          // Try to get token from localStorage first - check multiple possible keys
          if (!accessToken) {
            accessToken = localStorage.getItem('accessToken') || 
                        localStorage.getItem('authToken') || 
                        localStorage.getItem('adminToken');
          }
          
          // Log the token status for debugging
          console.log('Access token status:', accessToken ? 'Found' : 'Not found');
          
          // Check if we have a token
          if (!accessToken) {
            console.log('No token found, showing login required');
            updateUserStatus(false);
            showLoginRequired();
            return;
          }
          
          // Try to get current user to validate token
          try {
            currentUser = await getCurrentUser();
            if (currentUser) {
              console.log('User authenticated:', currentUser);
              updateUserStatus(true, currentUser);
              
              // åˆå§‹åŒ–æ‡‰ç”¨åŠŸèƒ½
              initTabNavigation();
              setupFileUpload();
              
              // åˆ‡æ›åˆ°æª”æ¡ˆé¸é …å¡ä¸¦è¼‰å…¥æª”æ¡ˆ
              switchTab('files');
            } else {
              throw new Error('Invalid user data');
            }
          } catch (authError) {
            console.log('Authentication failed:', authError);
            // Token might be expired, clear it and show login
            clearAuthData();
            updateUserStatus(false);
            showLoginRequired();
          }
          
        } catch (error) {
          console.error("Initialization error:", error);
          clearAuthData();
          updateUserStatus(false);
          showLoginRequired();
        }
      }
      
      // Helper function to show login UI
      function showLoginUI() {
        document.querySelector('.user-info').style.display = 'none';
        const logoutBtn = document.querySelector('.user-menu button[onclick="logout()"]');
        if (logoutBtn) {
          logoutBtn.style.display = 'none';
        }
        
        // Remove any existing login button first
        const existingLoginBtn = document.querySelector('.user-menu .login-button');
        if (existingLoginBtn) {
          existingLoginBtn.remove();
        }
        
        // Create login options container
        const loginContainer = document.createElement('div');
        loginContainer.className = 'login-button';
        loginContainer.innerHTML = `
          <button class="btn btn-primary" onclick="window.location.href='/'">
            OAuth ç™»å…¥
          </button>
        `;
        
        document.querySelector('.user-menu').appendChild(loginContainer);
      }
      
      // Helper function to clear auth data
      function clearAuthData() {
        localStorage.removeItem("accessToken");
        localStorage.removeItem("authToken");
        localStorage.removeItem("adminToken");
        localStorage.removeItem("refreshToken");
        localStorage.removeItem("user");
        accessToken = null;
      }

      // Authentication
      async function getCurrentUser() {
        try {
          // Check if we have a mock user from dev login
          const mockUser = localStorage.getItem("user");
          if (mockUser) {
            const user = JSON.parse(mockUser);
            if (user.provider === "dev-mock") {
              return user;
            }
          }

          // Try real API for OAuth users
          const response = await fetch("/api/auth/me", {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            return data.user;
          }
          return null;
        } catch (error) {
          console.error("Failed to get user:", error);
          // Check if we have mock user as fallback
          const mockUser = localStorage.getItem("user");
          if (mockUser) {
            const user = JSON.parse(mockUser);
            if (user.provider === "dev-mock") {
              return user;
            }
          }
          return null;
        }
      }

      function updateUserInfo() {
        document.getElementById("userName").textContent = currentUser.name;
        // Use a simple local avatar or background color instead of external HTTPS API
        const avatar = currentUser.avatar || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%233b82f6'/%3E%3Ctext x='20' y='26' text-anchor='middle' fill='white' font-size='16' font-family='Arial'%3E" + (currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U') + "%3C/text%3E%3C/svg%3E";
        document.getElementById("userAvatar").src = avatar;
      }

      async function logout() {
        try {
          await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
        } catch (error) {
          console.error('Logout error:', error);
        } finally {
          clearAuthData();
          window.location.href = "/";
        }
      }

      // ç§»é™¤å…§åµŒçš„é–‹ç™¼ç™»å…¥å‡½æ•¸ï¼Œçµ±ä¸€ä½¿ç”¨ dev-login.html

      // Tab Management
      function switchTab(tabName) {
        // Update navigation
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active");

        // Update content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`${tabName}-tab`).classList.add("active");

        // Update title
        const titles = {
          dashboard: "å„€è¡¨æ¿",
          files: "æª”æ¡ˆç®¡ç†",
          pages: "ä¸‹è¼‰é é¢",
          leads: "æ½›åœ¨å®¢æˆ¶",
          "file-creator": "æª”æ¡ˆè£½ä½œ",
        };
        document.getElementById("pageTitle").textContent = titles[tabName];

        // Load content
        switch (tabName) {
          case "dashboard":
            loadDashboard();
            break;
          case "files":
            loadFiles();
            break;
          case "pages":
            loadPages();
            break;
          case "leads":
            loadLeads();
            break;
        }
      }

      // Navigation event listeners
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const tab = item.getAttribute("data-tab");
          switchTab(tab);
        });
      });

      // Dashboard
      async function loadDashboard() {
        console.log("Loading dashboard statistics...");
        
        try {
          // Get token from localStorage
          const token = localStorage.getItem('accessToken') || 
                       localStorage.getItem('authToken') || 
                       localStorage.getItem('adminToken');
          
          if (!token) {
            console.error('No authentication token found');
            return;
          }
          
          // Get analytics data
          const response = await fetch('/api/analytics', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            const analytics = data.data.overview;
            
            // Update dashboard statistics
            document.getElementById('totalFiles').textContent = analytics.totalFiles || 0;
            document.getElementById('totalPages').textContent = analytics.totalPages || 0;
            document.getElementById('totalDownloads').textContent = analytics.totalDownloads || 0;
            document.getElementById('totalLeads').textContent = analytics.totalLeads || 0;
            
            console.log('Dashboard statistics loaded successfully:', analytics);
          } else {
            console.error('Failed to load dashboard statistics:', response.status, response.statusText);
            // Keep default 0 values on error
          }
        } catch (error) {
          console.error('Error loading dashboard statistics:', error);
        }
      }

      // File Management
      function setupFileUpload() {
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");

        uploadArea.addEventListener("click", () => {
          fileInput.click();
        });

        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
          const files = Array.from(e.dataTransfer.files);
          uploadFiles(files);
        });

        fileInput.addEventListener("change", (e) => {
          const files = Array.from(e.target.files);
          uploadFiles(files);
        });
      }

      async function uploadFiles(fileList) {
        const progressContainer = document.getElementById("uploadProgress");
        const progressBar = document.getElementById("progressBar");
        const statusText = document.getElementById("uploadStatus");

        progressContainer.classList.remove("hidden");
        
        // é˜²æ­¢é‡è¤‡ä¸Šå‚³ - ç¦ç”¨ä¸Šå‚³å€åŸŸ
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");
        uploadArea.style.pointerEvents = 'none';
        uploadArea.style.opacity = '0.6';
        if (fileInput) fileInput.disabled = true;

        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < fileList.length; i++) {
          const file = fileList[i];
          statusText.textContent = `æ­£åœ¨ä¸Šå‚³: ${file.name} (${i + 1}/${fileList.length})`;

          try {
            const formData = new FormData();
            formData.append("file", file);

            const response = await fetch("/api/files", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
              body: formData,
            });

            if (response.ok) {
              const result = await response.json();
              if (result.message === "File already exists") {
                console.log(`æª”æ¡ˆå·²å­˜åœ¨: ${file.name}`);
              } else {
                successCount++;
              }
              const progress = ((i + 1) / fileList.length) * 100;
              progressBar.style.width = `${progress}%`;
            } else {
              failCount++;
              const errorText = await response.text();
              let errorData;
              try {
                errorData = JSON.parse(errorText);
              } catch {
                errorData = { error: errorText };
              }
              
              // Check for token expiration
              if (response.status === 401 && errorData.error === "Token expired") {
                clearAuthData();
                alert("ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥");
                window.location.href = "/dev-login.html?returnTo=/admin.html";
                return;
              }
              
              console.error(`Upload failed for ${file.name}:`, errorData);
              statusText.textContent = `ä¸Šå‚³å¤±æ•—: ${file.name} - ${errorData.error || errorText}`;
              
              // çµ¦ç”¨æˆ¶ä¸€äº›æ™‚é–“çœ‹åˆ°éŒ¯èª¤ä¿¡æ¯
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          } catch (error) {
            failCount++;
            console.error("Upload error:", error);
            statusText.textContent = `ä¸Šå‚³å¤±æ•—: ${file.name} - ${error.message}`;
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }

        // é¡¯ç¤ºæœ€çµ‚çµæœ
        if (failCount === 0) {
          statusText.textContent = `ä¸Šå‚³å®Œæˆï¼æˆåŠŸä¸Šå‚³ ${successCount} å€‹æª”æ¡ˆ`;
        } else {
          statusText.textContent = `ä¸Šå‚³å®Œæˆï¼š${successCount} æˆåŠŸï¼Œ${failCount} å¤±æ•—`;
        }
        
        // é‡æ–°å•Ÿç”¨ä¸Šå‚³å€åŸŸä¸¦é‡ç½®é€²åº¦æ¢
        setTimeout(() => {
          progressContainer.classList.add("hidden");
          progressBar.style.width = "0%";
          uploadArea.style.pointerEvents = '';
          uploadArea.style.opacity = '';
          if (fileInput) {
            fileInput.disabled = false;
            fileInput.value = ''; // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
          }
        }, 2000);
        
        // é‡æ–°è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
        await loadFiles();
      }



      // Page Management
      async function loadPages() {
        const loading = document.getElementById("pagesLoading");
        const list = document.getElementById("pagesList");
        const tbody = document.getElementById("pagesTableBody");

        loading.classList.remove("hidden");
        list.classList.add("hidden");

        try {
          const response = await fetch("/api/pages", {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            pages = data.pages || [];

            tbody.innerHTML = pages
              .map(
                (page) => `
              <tr>
                <td>${page.title}</td>
                <td>${page.file ? page.file.originalName : "ç„¡"}</td>
                <td>${page.views || 0}</td>
                <td>${page.downloads || 0}</td>
                <td>${formatDate(page.createdAt)}</td>
                <td><span class="badge ${
                  page.isActive ? "badge-success" : "badge-warning"
                }">${page.isActive ? "å•Ÿç”¨" : "åœç”¨"}</span></td>
                <td>
                  <button class="btn btn-secondary" onclick="viewPage('${
                    page.slug
                  }')">é è¦½</button>
                  <button class="btn btn-secondary" onclick="copyPageUrl('${
                    page.slug
                  }')">è¤‡è£½é€£çµ</button>
                  <button class="btn btn-primary" onclick="editPage('${
                    page.id
                  }')">ç·¨è¼¯</button>
                  <button class="btn btn-danger" onclick="deletePage('${
                    page.id
                  }')">åˆªé™¤</button>
                </td>
              </tr>
            `
              )
              .join("");

            list.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Failed to load pages:", error);
        } finally {
          loading.classList.add("hidden");
        }
      }

      async function showCreatePageModal() {
        // Populate file options
        const fileSelect = document.querySelector(
          '#createPageModal select[name="fileId"]'
        );
        
        // First, ensure we have the latest files list
        if (currentFiles.length === 0) {
          try {
            const response = await fetch('/api/files', {
              headers: {
                'Authorization': `Bearer ${accessToken}`,
              },
            });
            
            if (response.ok) {
              const data = await response.json();
              currentFiles = data.files || [];
            }
          } catch (error) {
            console.error('Failed to load files for modal:', error);
          }
        }
        
        // Populate file options using currentFiles
        fileSelect.innerHTML =
          '<option value="">è«‹é¸æ“‡æª”æ¡ˆ</option>' +
          currentFiles
            .map(
              (file) =>
                `<option value="${file.id}">${file.originalName || file.name}</option>`
            )
            .join("");

        // Reset image manager
        pageImages.create = [];
        updateImageManager('create');
        
        document.getElementById("createPageModal").classList.add("show");
      }

      function hideCreatePageModal() {
        document.getElementById("createPageModal").classList.remove("show");
      }

      // Lead Management
      async function loadLeads() {
        const loading = document.getElementById("leadsLoading");
        const list = document.getElementById("leadsList");
        const tbody = document.getElementById("leadsTableBody");

        loading.classList.remove("hidden");
        list.classList.add("hidden");

        try {
          const response = await fetch("/api/analytics/leads", {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            leads = data.leads || [];

            tbody.innerHTML = leads
              .map(
                (lead) => `
              <tr>
                <td>${lead.email}</td>
                <td>${lead.name || "æœªæä¾›"}</td>
                <td>${lead.page ? lead.page.title : "æœªçŸ¥"}</td>
                <td>${lead.file ? lead.file.originalName : "æœªçŸ¥"}</td>
                <td>${formatDate(lead.createdAt)}</td>
                <td>
                  <button class="btn btn-secondary" onclick="exportSingleLead('${
                    lead.id
                  }')">åŒ¯å‡º</button>
                </td>
              </tr>
            `
              )
              .join("");

            list.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Failed to load leads:", error);
        } finally {
          loading.classList.add("hidden");
        }
      }

      // Utility functions
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return (
          date.toLocaleDateString("zh-TW") +
          " " +
          date.toLocaleTimeString("zh-TW")
        );
      }

      // Page management functions
      function viewPage(slug) {
        // Open preview page in new tab
        window.open(`/download-page/${slug}`, '_blank');
      }

      // è¤‡è£½é é¢é€£çµ
      function copyPageUrl(slug) {
        const url = `${window.location.origin}/download-page/${slug}`;
        
        if (navigator.clipboard && window.isSecureContext) {
          // ä½¿ç”¨ç¾ä»£å‰ªè²¼ç°¿ API
          navigator.clipboard.writeText(url).then(() => {
            showCopyNotification('é é¢é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
          }).catch(err => {
            console.error('Failed to copy: ', err);
            fallbackCopyTextToClipboard(url);
          });
        } else {
          // å‚™ç”¨æ–¹æ¡ˆ
          fallbackCopyTextToClipboard(url);
        }
      }

      // å‚™ç”¨è¤‡è£½æ–¹æ¡ˆ
      function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        
        // é¿å…åœ¨iOSä¸­ç¸®æ”¾
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          const successful = document.execCommand('copy');
          const msg = successful ? 'é é¢é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿' : 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½';
          showCopyNotification(msg);
        } catch (err) {
          console.error('Fallback: Oops, unable to copy', err);
          showCopyNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
        }

        document.body.removeChild(textArea);
      }

      // é¡¯ç¤ºè¤‡è£½é€šçŸ¥
      function showCopyNotification(message) {
        // å‰µå»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = 'copy-notification';
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #10b981;
          color: white;
          padding: 12px 20px;
          border-radius: 6px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          z-index: 9999;
          font-size: 14px;
          font-weight: 500;
          transition: all 0.3s ease;
          opacity: 0;
          transform: translateY(-10px);
        `;
        
        document.body.appendChild(notification);
        
        // è§¸ç™¼å‹•ç•«
        setTimeout(() => {
          notification.style.opacity = '1';
          notification.style.transform = 'translateY(0)';
        }, 10);
        
        // 3ç§’å¾Œç§»é™¤
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      function editPage(pageId) {
        // Find the page data
        const page = pages.find(p => p.id === parseInt(pageId));
        if (!page) {
          alert('é é¢ä¸å­˜åœ¨');
          return;
        }

        // Populate edit form
        document.getElementById('editPageTitle').value = page.title;
        document.getElementById('editPageDescription').value = page.description || '';
        
        // Set file selection
        const fileSelect = document.getElementById('editPageFileId');
        fileSelect.value = page.fileId || '';

        // è¼‰å…¥é é¢åœ–ç‰‡è³‡æ–™
        pageImages.edit = [];
        if (page.images) {
          try {
            const images = JSON.parse(page.images);
            pageImages.edit = images.map(url => ({
              type: 'url',
              url: url,
              preview: url
            }));
          } catch (error) {
            console.error('è§£æåœ–ç‰‡è³‡æ–™å¤±æ•—:', error);
          }
        }
        
        // æ›´æ–°åœ–ç‰‡ç®¡ç†å™¨é¡¯ç¤º
        updateImageManager('edit');

        // Store page ID for update
        editingPageId = pageId;

        // Show edit modal
        showEditPageModal();
      }

      function deletePage(pageId) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é é¢å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
          return;
        }

        fetch(`/api/pages/${pageId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
          },
        })
        .then(response => {
          if (response.ok) {
            alert('é é¢å·²åˆªé™¤');
            loadPages();
          } else {
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
          }
        })
        .catch(error => {
          console.error('Delete error:', error);
          alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        });
      }

      // Edit modal functions
      let editingPageId = null;

      function showEditPageModal() {
        document.getElementById('editPageModal').classList.add('show');
        loadFilesForEdit(); // Load files for selection
      }

      function hideEditPageModal() {
        document.getElementById('editPageModal').classList.remove('show');
        editingPageId = null;
      }

      async function loadFilesForEdit() {
        try {
          const response = await fetch('/api/files', {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            const fileSelect = document.getElementById('editPageFileId');
            
            fileSelect.innerHTML = '<option value="">é¸æ“‡æª”æ¡ˆ (å¯é¸)</option>';
            data.files.forEach(file => {
              const option = document.createElement('option');
              option.value = file.id;
              option.textContent = file.originalName;
              fileSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Load files error:', error);
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        setupFileUpload();
        init();
      });

      // Form submission
      document
        .getElementById("createPageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const pageData = Object.fromEntries(formData);

          try {
            // å…ˆä¸Šå‚³åœ–ç‰‡
            const imageUrls = await uploadImages('create');
            if (imageUrls === null) return; // åœ–ç‰‡ä¸Šå‚³å¤±æ•—
            
            // æ·»åŠ åœ–ç‰‡åˆ°é é¢æ•¸æ“š
            pageData.images = JSON.stringify(imageUrls);

            const response = await fetch("/api/pages", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(pageData),
            });

            if (response.ok) {
              hideCreatePageModal();
              loadPages();
              // æ¸…ç©ºåœ–ç‰‡åˆ—è¡¨
              pageImages.create = [];
              updateImageManager('create');
              alert("é é¢å»ºç«‹æˆåŠŸï¼");
            } else {
              alert("å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
            }
          } catch (error) {
            console.error("Create page error:", error);
            alert("å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
          }
        });

      // Edit Page Form submission
      document
        .getElementById("editPageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          
          if (!editingPageId) {
            alert("ç„¡æ•ˆçš„é é¢ID");
            return;
          }

          const formData = new FormData(e.target);
          const updateData = Object.fromEntries(formData);

          // Remove empty fileId
          if (!updateData.fileId) {
            updateData.fileId = null;
          }

          try {
            // å…ˆä¸Šå‚³åœ–ç‰‡
            const imageUrls = await uploadImages('edit');
            if (imageUrls === null) return; // åœ–ç‰‡ä¸Šå‚³å¤±æ•—
            
            // æ·»åŠ åœ–ç‰‡åˆ°æ›´æ–°æ•¸æ“š
            updateData.images = JSON.stringify(imageUrls);

            const response = await fetch(`/api/pages/${editingPageId}`, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updateData),
            });

            if (response.ok) {
              hideEditPageModal();
              loadPages();
              alert("é é¢æ›´æ–°æˆåŠŸï¼");
            } else {
              const errorData = await response.json();
              alert(`æ›´æ–°å¤±æ•—ï¼š${errorData.message || 'è«‹ç¨å¾Œé‡è©¦'}`);
            }
          } catch (error) {
            console.error("Update page error:", error);
            alert("æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
          }
        });

      // Image Management Functions
      let pageImages = { create: [], edit: [] };

      function showImageUploadOption(mode) {
        const uploadArea = document.getElementById(`${mode}ImageUploadArea`);
        uploadArea.classList.remove('hidden');
        document.getElementById(`${mode}ImageUrlArea`).classList.add('hidden');
        
        // ç¶å®šæ–‡ä»¶ä¸Šå‚³äº‹ä»¶
        const uploadInput = document.getElementById(`${mode}ImageUpload`);
        uploadInput.onchange = function(e) {
          handleImageUpload(e, mode);
        };
        
        // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        setupDragAndDrop(uploadArea, mode);
      }

      function showImageUrlOption(mode) {
        document.getElementById(`${mode}ImageUrlArea`).classList.remove('hidden');
        document.getElementById(`${mode}ImageUploadArea`).classList.add('hidden');
      }

      // è¨­ç½®æ‹–æ‹½ä¸Šå‚³åŠŸèƒ½
      function setupDragAndDrop(uploadArea, mode) {
        // é˜²æ­¢é è¨­çš„æ‹–æ‹½è¡Œç‚º
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // é«˜äº®æ‹–æ‹½å€åŸŸ
        ['dragenter', 'dragover'].forEach(eventName => {
          uploadArea.addEventListener(eventName, () => highlight(uploadArea), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          uploadArea.addEventListener(eventName, () => unhighlight(uploadArea), false);
        });
        
        // è™•ç†æª”æ¡ˆæ”¾ç½®
        uploadArea.addEventListener('drop', (e) => handleDrop(e, mode), false);
      }
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      function highlight(uploadArea) {
        uploadArea.style.borderColor = '#3b82f6';
        uploadArea.style.backgroundColor = '#eff6ff';
        uploadArea.style.borderStyle = 'solid';
      }
      
      function unhighlight(uploadArea) {
        uploadArea.style.borderColor = '#d1d5db';
        uploadArea.style.backgroundColor = 'white';
        uploadArea.style.borderStyle = 'dashed';
      }
      
      function handleDrop(e, mode) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        // éæ¿¾åªä¿ç•™åœ–ç‰‡æª”æ¡ˆ
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
        
        if (imageFiles.length === 0) {
          alert('è«‹åªä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ (JPG, PNG, GIF ç­‰)');
          return;
        }
        
        // è™•ç†æ‹–æ‹½çš„åœ–ç‰‡æª”æ¡ˆ
        processDraggedImages(imageFiles, mode);
      }
      
      function processDraggedImages(files, mode) {
        const preview = document.getElementById(`${mode}UploadPreview`);
        
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            preview.appendChild(img);
            
            // æ·»åŠ åˆ°åœ–ç‰‡åˆ—è¡¨
            pageImages[mode].push({
              type: 'upload',
              file: file,
              preview: e.target.result
            });
            
            // æ›´æ–°åœ–ç‰‡ç®¡ç†å™¨
            updateImageManager(mode);
          };
          reader.readAsDataURL(file);
        });
      }

      function handleImageUpload(event, mode) {
        const files = event.target.files;
        const preview = document.getElementById(`${mode}UploadPreview`);
        preview.innerHTML = '';

        for (let file of files) {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              preview.appendChild(img);
              
              // æ·»åŠ åˆ°åœ–ç‰‡åˆ—è¡¨
              pageImages[mode].push({
                type: 'upload',
                file: file,
                preview: e.target.result
              });
            };
            reader.readAsDataURL(file);
          }
        }
        
        updateImageManager(mode);
      }

      function addImageUrl(mode) {
        const urlInput = document.getElementById(`${mode}ImageUrl`);
        const url = urlInput.value.trim();
        
        if (url) {
          // é©—è­‰åœ–ç‰‡URL
          const img = new Image();
          img.onload = function() {
            pageImages[mode].push({
              type: 'url',
              url: url,
              preview: url
            });
            updateImageManager(mode);
            urlInput.value = '';
          };
          img.onerror = function() {
            alert('ç„¡æ³•è¼‰å…¥åœ–ç‰‡ï¼Œè«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢º');
          };
          img.src = url;
        }
      }

      function updateImageManager(mode) {
        const container = document.getElementById(`${mode}PageImages`);
        
        if (pageImages[mode].length === 0) {
          container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">å°šæœªæ·»åŠ åœ–ç‰‡</p>';
          return;
        }

        const imageList = document.createElement('div');
        imageList.className = 'image-list';

        pageImages[mode].forEach((image, index) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';
          
          imageItem.innerHTML = `
            <img src="${image.preview}" alt="åœ–ç‰‡ ${index + 1}">
            <div class="image-item-controls">
              <button type="button" class="image-btn" onclick="moveImage('${mode}', ${index}, -1)" title="å‘å‰ç§»å‹•">â†‘</button>
              <button type="button" class="image-btn" onclick="moveImage('${mode}', ${index}, 1)" title="å‘å¾Œç§»å‹•">â†“</button>
              <button type="button" class="image-btn" onclick="removeImage('${mode}', ${index})" title="åˆªé™¤">Ã—</button>
            </div>
          `;
          
          imageList.appendChild(imageItem);
        });

        container.innerHTML = '';
        container.appendChild(imageList);
        
        // æ·»åŠ åœ–ç‰‡æ•¸é‡æç¤º
        const info = document.createElement('p');
        info.style.color = '#6b7280';
        info.style.fontSize = '0.875rem';
        info.style.marginTop = '0.5rem';
        info.textContent = `å·²æ·»åŠ  ${pageImages[mode].length} å¼µåœ–ç‰‡${pageImages[mode].length > 1 ? 'ï¼ˆå°‡é¡¯ç¤ºç‚ºè¼ªæ’­åœ–ï¼‰' : ''}`;
        container.appendChild(info);
      }

      function moveImage(mode, index, direction) {
        const images = pageImages[mode];
        const newIndex = index + direction;
        
        if (newIndex >= 0 && newIndex < images.length) {
          [images[index], images[newIndex]] = [images[newIndex], images[index]];
          updateImageManager(mode);
        }
      }

      function removeImage(mode, index) {
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µåœ–ç‰‡å—ï¼Ÿ')) {
          pageImages[mode].splice(index, 1);
          updateImageManager(mode);
        }
      }

      async function uploadImages(mode) {
        const uploadedUrls = [];
        
        for (const image of pageImages[mode]) {
          if (image.type === 'upload') {
            const formData = new FormData();
            formData.append('images', image.file);
            
            try {
              const response = await fetch('/api/upload-images', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                },
                body: formData
              });
              
              if (response.ok) {
                const result = await response.json();
                uploadedUrls.push(result.urls[0]);
              } else {
                throw new Error('åœ–ç‰‡ä¸Šå‚³å¤±æ•—');
              }
            } catch (error) {
              console.error('Image upload error:', error);
              alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
              return null;
            }
          } else {
            uploadedUrls.push(image.url);
          }
        }
        
        return uploadedUrls;
      }

      // æ·»åŠ æ¨¡æ…‹æ¡†å¤–éƒ¨é»æ“Šé—œé–‰åŠŸèƒ½
      function setupModalClickToClose() {
        const modals = document.querySelectorAll('.modal');
        
        modals.forEach(modal => {
          modal.addEventListener('click', function(e) {
            // å¦‚æœé»æ“Šçš„æ˜¯æ¨¡æ…‹æ¡†èƒŒæ™¯ï¼ˆè€Œä¸æ˜¯æ¨¡æ…‹æ¡†å…§å®¹ï¼‰ï¼Œå‰‡é—œé–‰æ¨¡æ…‹æ¡†
            if (e.target === modal) {
              modal.classList.remove('show');
            }
          });
        });

        // æ·»åŠ  ESC éµé—œé–‰æ¨¡æ…‹æ¡†åŠŸèƒ½
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            const openModal = document.querySelector('.modal.show');
            if (openModal) {
              openModal.classList.remove('show');
            }
          }
        });
      }

      // é é¢è¼‰å…¥æ™‚è¨­ç½®æ¨¡æ…‹æ¡†é»æ“Šé—œé–‰åŠŸèƒ½
      document.addEventListener('DOMContentLoaded', function() {
        setupModalClickToClose();
      });
    </script>

    <!-- ç¢ºèªåˆªé™¤å°è©±æ¡† -->
    <div id="deleteConfirmDialog" class="confirm-dialog">
      <div class="confirm-content">
        <h3>ç¢ºèªåˆªé™¤</h3>
        <p id="deleteConfirmMessage">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹æª”æ¡ˆå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚</p>
        <div class="confirm-actions">
          <button class="btn-cancel" onclick="hideDeleteConfirm()">å–æ¶ˆ</button>
          <button class="btn-delete" onclick="confirmDelete()">åˆªé™¤</button>
        </div>
      </div>
    </div>
  </body>
</html>

    <script>
      // å…¨åŸŸè®Šæ•¸
      // Token will be set by earlier initialization code
      
      // æª”æ¡ˆç®¡ç†ç›¸é—œè®Šæ•¸å·²åœ¨ä¸Šæ–¹å®šç¾©
      // æª¢æŸ¥èº«ä»½é©—è­‰
      function checkAuth() {
        if (!accessToken) {
          // åœ¨é–‹ç™¼ç’°å¢ƒä¸­è‡ªå‹•ç™»å…¥
          autoDevLogin();
          return false;
        }
        return true;
      }

      // è‡ªå‹•é–‹ç™¼ç™»å…¥
      async function autoDevLogin() {
        try {
          const response = await fetch('/api/auth/dev-login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              email: 'admin@test.com', 
              name: 'Admin User' 
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            accessToken = data.tokens.accessToken;
            localStorage.setItem('adminToken', accessToken);
            localStorage.setItem('accessToken', accessToken);
            
            // åˆå§‹åŒ–æ‡‰ç”¨
            initApp();
          } else {
            console.error('Auto login failed');
            showLoginForm();
          }
        } catch (error) {
          console.error('Auto login error:', error);
          showLoginForm();
        }
      }

      // é¡¯ç¤ºç™»å…¥è¡¨å–®
      function showLoginForm() {
        const loginHtml = `
          <div style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 8px;
              width: 100%;
              max-width: 400px;
            ">
              <h2 style="margin-bottom: 1rem;">ç®¡ç†å“¡ç™»å…¥</h2>
              <form id="loginForm">
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem;">ä½¿ç”¨è€…åç¨±</label>
                  <input type="text" id="username" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem;">å¯†ç¢¼</label>
                  <input type="password" id="password" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <button type="submit" style="width: 100%; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">ç™»å…¥</button>
              </form>
              <div id="loginError" style="color: red; margin-top: 1rem; display: none;"></div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', loginHtml);
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          
          try {
            const response = await fetch('/api/auth/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ username, password })
            });
            
            if (response.ok) {
              const data = await response.json();
              accessToken = data.token;
              localStorage.setItem('adminToken', accessToken);
              
              // ç§»é™¤ç™»å…¥è¡¨å–®
              document.querySelector('[style*="position: fixed"]').remove();
              
              // åˆå§‹åŒ–æ‡‰ç”¨
              initApp();
            } else {
              const error = await response.json();
              document.getElementById('loginError').textContent = error.message || 'ç™»å…¥å¤±æ•—';
              document.getElementById('loginError').style.display = 'block';
            }
          } catch (error) {
            document.getElementById('loginError').textContent = 'é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦';
            document.getElementById('loginError').style.display = 'block';
          }
        });
      }

      // åˆå§‹åŒ–æ‡‰ç”¨
      function initApp() {
        initTabNavigation();
        setupFileUpload();
        
        // åˆ‡æ›åˆ°æª”æ¡ˆé¸é …å¡ä¸¦è¼‰å…¥æª”æ¡ˆ
        switchTab('files');
      }


      // æª”æ¡ˆé¡å‹åœ–æ¨™æ˜ å°„
      // åˆ‡æ›æª”æ¡ˆè¦–åœ–
      function switchFilesView(view) {
        currentView = view;
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.view-toggle button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        // åˆ‡æ›è¦–åœ–
        if (view === 'grid') {
          document.getElementById('filesGrid').style.display = 'grid';
          document.getElementById('filesList').style.display = 'none';
        } else {
          document.getElementById('filesGrid').style.display = 'none';
          document.getElementById('filesList').style.display = 'block';
        }
        
        renderFiles();
      }

      // ç²å–æª”æ¡ˆé¡å‹åœ–æ¨™
      function getFileTypeIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        return fileTypeIcons[extension] || fileTypeIcons.default;
      }

      // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
      // æ ¼å¼åŒ–æ—¥æœŸ
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
      }

      // æ¸²æŸ“æª”æ¡ˆ
      function renderFiles() {
        console.log('renderFiles called, currentView:', currentView, 'currentFiles:', currentFiles.length);
        console.log('Current files data:', currentFiles);
        if (currentView === 'grid') {
          renderFilesGrid();
        } else {
          renderFilesList();
        }
      }

      // æ¸²æŸ“ç¶²æ ¼è¦–åœ–
      function renderFilesGrid() {
        console.log('renderFilesGrid called');
        const container = document.getElementById('filesGrid');
        console.log('Grid container found:', !!container);
        console.log('Current files count:', currentFiles.length);
        console.log('Files data:', currentFiles);
        
        if (!container) {
          console.error('Grid container not found!');
          return;
        }
        
        if (currentFiles.length === 0) {
          console.log('No files to display');
          container.innerHTML = '';
          return;
        }
        
        console.log('Starting to generate HTML for files...');
        const html = currentFiles.map((file, index) => {
          console.log(`Processing file ${index}:`, file);
          const typeInfo = getFileTypeIcon(file.name);
          console.log(`File type info for ${file.name}:`, typeInfo);
          return `
            <div class="file-card" data-file-id="${file.id}">
              <div class="file-actions">
                <button class="action-btn download" onclick="downloadFile('${file.downloadSlug}')" title="ä¸‹è¼‰">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                  </svg>
                </button>
                <button class="action-btn edit" onclick="editFile('${file.id}')" title="ç·¨è¼¯">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                  </svg>
                </button>
                <button class="action-btn delete" onclick="showDeleteConfirm('${file.id}', '${file.name}')" title="åˆªé™¤">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                </button>
              </div>
              <div class="file-icon ${typeInfo.class}">
                ${typeInfo.icon}
              </div>
              <div class="file-name" title="${file.name}">${file.name}</div>
              <div class="file-meta">${formatFileSize(file.sizeBytes)}</div>
              <div class="file-stats">
                <span>${file.downloads} æ¬¡ä¸‹è¼‰</span>
                <span class="file-status ${file.isActive ? 'active' : 'inactive'}">
                  ${file.isActive ? 'å•Ÿç”¨' : 'åœç”¨'}
                </span>
              </div>
            </div>
          `;
        }).join('');
        
        console.log('Generated HTML length:', html.length);
        console.log('Generated HTML preview:', html.substring(0, 200) + '...');
        container.innerHTML = html;
        console.log('HTML set to container, container children count:', container.children.length);
      }

      // æ¸²æŸ“åˆ—è¡¨è¦–åœ–
      function renderFilesList() {
        const tbody = document.getElementById('filesTableBody');
        
        if (currentFiles.length === 0) {
          tbody.innerHTML = '';
          return;
        }
        
        const html = currentFiles.map(file => {
          const typeInfo = getFileTypeIcon(file.name);
          return `
            <tr data-file-id="${file.id}">
              <td>
                <div class="table-file-info">
                  <div class="table-file-icon ${typeInfo.class}">
                    ${typeInfo.icon}
                  </div>
                  <div class="table-file-details">
                    <div class="table-file-name">${file.name}</div>
                    <div class="table-file-meta">${file.originalName}</div>
                  </div>
                </div>
              </td>
              <td>${formatFileSize(file.sizeBytes)}</td>
              <td>${file.downloads}</td>
              <td>${formatDate(file.createdAt)}</td>
              <td>
                <div class="table-actions">
                  <button class="action-btn download" onclick="downloadFile('${file.downloadSlug}')" title="ä¸‹è¼‰">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                    </svg>
                  </button>
                  <button class="action-btn edit" onclick="editFile('${file.id}')" title="ç·¨è¼¯">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <button class="action-btn delete" onclick="showDeleteConfirm('${file.id}', '${file.name}')" title="åˆªé™¤">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.innerHTML = html;
      }

      // é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
      function showDeleteConfirm(fileId, fileName) {
        deleteFileId = fileId;
        document.getElementById('deleteConfirmMessage').textContent = `æ‚¨ç¢ºå®šè¦åˆªé™¤æª”æ¡ˆã€Œ${fileName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚`;
        document.getElementById('deleteConfirmDialog').classList.add('show');
      }

      // éš±è—åˆªé™¤ç¢ºèªå°è©±æ¡†
      function hideDeleteConfirm() {
        deleteFileId = null;
        document.getElementById('deleteConfirmDialog').classList.remove('show');
      }

      // ç¢ºèªåˆªé™¤æª”æ¡ˆ
      async function confirmDelete() {
        if (!deleteFileId) return;
        
        try {
          const response = await fetch(`/api/files/${deleteFileId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            hideDeleteConfirm();
            loadFiles(); // é‡æ–°è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
            alert('æª”æ¡ˆåˆªé™¤æˆåŠŸï¼');
          } else {
            const error = await response.json();
            alert(`åˆªé™¤å¤±æ•—ï¼š${error.message || 'è«‹ç¨å¾Œé‡è©¦'}`);
          }
        } catch (error) {
          console.error('Delete file error:', error);
          alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        }
      }

      // ä¸‹è¼‰æª”æ¡ˆ
      function downloadFile(downloadSlug) {
        window.open(`/download/${downloadSlug}`, '_blank');
      }

      // ç·¨è¼¯æª”æ¡ˆ
      function editFile(fileId) {
        // é€™è£¡å¯ä»¥å¯¦ç¾æª”æ¡ˆç·¨è¼¯åŠŸèƒ½ï¼Œä¾‹å¦‚é‡æ–°å‘½åæˆ–æ›´æ”¹æè¿°
        const fileName = prompt('è«‹è¼¸å…¥æ–°çš„æª”æ¡ˆåç¨±ï¼š');
        if (fileName && fileName.trim()) {
          updateFileName(fileId, fileName.trim());
        }
      }

      // æ›´æ–°æª”æ¡ˆåç¨±
      async function updateFileName(fileId, newName) {
        try {
          const response = await fetch(`/api/files/${fileId}`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: newName })
          });
          
          if (response.ok) {
            loadFiles(); // é‡æ–°è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
            alert('æª”æ¡ˆåç¨±æ›´æ–°æˆåŠŸï¼');
          } else {
            const error = await response.json();
            alert(`æ›´æ–°å¤±æ•—ï¼š${error.message || 'è«‹ç¨å¾Œé‡è©¦'}`);
          }
        } catch (error) {
          console.error('Update file error:', error);
          alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        }
      }

      // è¼‰å…¥æª”æ¡ˆåˆ—è¡¨çš„æ›´æ–°ç‰ˆæœ¬
      async function loadFiles() {
        console.log('loadFiles called');
        const loadingEl = document.getElementById('filesLoading');
        const gridEl = document.getElementById('filesGrid');
        const listEl = document.getElementById('filesList');
        const emptyEl = document.getElementById('filesEmpty');
        
        console.log('DOM elements:', { loadingEl, gridEl, listEl, emptyEl });
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        if (loadingEl) loadingEl.style.display = 'block';
        if (gridEl) gridEl.style.display = 'none';
        if (listEl) listEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'none';
        
        try {
          console.log('Making API request with token:', accessToken ? 'exists' : 'missing');
          const response = await fetch('/api/files', {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          console.log('API response status:', response.status);
          
          if (response.ok) {
            const data = await response.json();
            console.log('API response data:', data);
            currentFiles = data.files || [];
            console.log('currentFiles length:', currentFiles.length);
            
            // éš±è—è¼‰å…¥ç‹€æ…‹
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (currentFiles.length === 0) {
              console.log('No files, showing empty state');
              if (emptyEl) emptyEl.style.display = 'block';
            } else {
              console.log('Files found, currentView:', currentView);
              // æ ¹æ“šç•¶å‰è¦–åœ–é¡¯ç¤ºå°æ‡‰å…§å®¹
              if (currentView === 'grid') {
                console.log('Showing grid view');
                if (gridEl) gridEl.style.display = 'grid';
              } else {
                console.log('Showing list view');
                if (listEl) listEl.style.display = 'block';
              }
              renderFiles();
            }
          } else {
            throw new Error('è¼‰å…¥æª”æ¡ˆå¤±æ•—: ' + response.status);
          }
        } catch (error) {
          console.error('Load files error:', error);
          if (loadingEl) loadingEl.style.display = 'none';
          if (emptyEl) {
            emptyEl.style.display = 'block';
            emptyEl.innerHTML = `
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <h3>è¼‰å…¥å¤±æ•—</h3>
              <p>ç„¡æ³•è¼‰å…¥æª”æ¡ˆåˆ—è¡¨ï¼š${error.message}</p>
              <button class="btn btn-primary" onclick="loadFiles()">é‡æ–°è¼‰å…¥</button>
            `;
          }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        init();
      });
